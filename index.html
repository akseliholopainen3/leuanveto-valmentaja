<!doctype html>
<html lang="fi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0b1220" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <link rel="manifest" href="manifest.webmanifest" />
  <link rel="icon" href="icons/icon-192.png" />
  <link rel="apple-touch-icon" href="icons/icon-192.png" />
  <title>LeVe Coach</title>
  <style>
    :root {
      --bg: #0b1220; --card: #121d33; --card2: #182744;
      --border: #26385d; --border2: #314976;
      --txt: #e8eefc; --muted: #8899bb; --dim: #5a6a8a;
      --acc: #4f8cff; --acc2: #3a6fd8;
      --ok: #22c55e; --ok2: #166534;
      --warn: #f59e0b; --warn2: #92400e;
      --bad: #ef4444; --bad2: #991b1b;
      --radius: 12px; --radius-sm: 8px;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
    html { font-size: 16px; overflow-x: hidden; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
      background: var(--bg); color: var(--txt);
      min-height: 100dvh;
      padding-top: env(safe-area-inset-top, 0);
      padding-bottom: env(safe-area-inset-bottom, 0);
      -webkit-text-size-adjust: 100%;
      overscroll-behavior-y: contain;
      user-select: none; -webkit-user-select: none;
    }
    input, textarea, select { user-select: auto; -webkit-user-select: auto; }
    a { color: var(--acc); }
    /* â”€â”€ Layout â”€â”€ */
    .app { max-width: 600px; margin: 0 auto; padding: 12px; padding-bottom: 90px; }
    /* â”€â”€ Nav â”€â”€ */
    .nav {
      position: fixed; bottom: 0; left: 0; right: 0; z-index: 100;
      background: rgba(13, 22, 40, 0.95); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
      border-top: 1px solid var(--border);
      display: flex; justify-content: space-around; padding: 8px 0;
      padding-bottom: max(8px, env(safe-area-inset-bottom));
    }
    .nav button {
      background: none; border: none; color: var(--muted); font-size: 10px;
      display: flex; flex-direction: column; align-items: center; gap: 3px;
      padding: 6px 10px; cursor: pointer; min-width: 60px; min-height: 48px;
    }
    .nav button.active { color: var(--acc); }
    .nav button .icon { font-size: 22px; }
    /* â”€â”€ Cards â”€â”€ */
    .card {
      background: var(--card); border: 1px solid var(--border);
      border-radius: var(--radius); padding: 14px; margin-bottom: 10px;
    }
    .card-title { font-size: 13px; color: var(--muted); font-weight: 600; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px; }
    /* â”€â”€ Buttons â”€â”€ */
    .btn {
      display: inline-flex; align-items: center; justify-content: center;
      background: var(--acc); color: #fff; border: none; border-radius: var(--radius-sm);
      padding: 12px 20px; font-size: 15px; font-weight: 600; cursor: pointer;
      min-height: 48px; transition: background 0.15s;
    }
    .btn:active { background: var(--acc2); }
    .btn-full { width: 100%; }
    .btn-big { padding: 16px 24px; font-size: 18px; border-radius: var(--radius); }
    .btn-outline { background: transparent; border: 1px solid var(--border2); color: var(--txt); }
    .btn-outline:active { background: var(--card2); }
    .btn-danger { background: var(--bad); }
    .btn-danger:active { background: var(--bad2); }
    .btn-ok { background: var(--ok); }
    .btn-ok:active { background: var(--ok2); }
    .btn-sm { padding: 8px 12px; font-size: 13px; min-height: 36px; }
    .btn-group { display: flex; gap: 6px; flex-wrap: wrap; }
    /* â”€â”€ Inputs â”€â”€ */
    input, select, textarea {
      width: 100%; padding: 10px 12px; border-radius: var(--radius-sm);
      border: 1px solid var(--border2); background: #0f1a31; color: var(--txt);
      font-size: 16px; min-height: 44px;
    }
    input:focus, select:focus, textarea:focus { outline: none; border-color: var(--acc); }
    textarea { min-height: 80px; resize: vertical; }
    label { display: block; font-size: 13px; color: var(--muted); margin-bottom: 4px; margin-top: 10px; }
    /* â”€â”€ Grid â”€â”€ */
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    .row3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; }
    /* â”€â”€ Tags / Chips â”€â”€ */
    .chip {
      display: inline-flex; align-items: center; padding: 6px 12px;
      border-radius: 999px; font-size: 13px; font-weight: 600;
      border: 1px solid var(--border2); background: var(--card2);
    }
    .chip-green { color: var(--ok); border-color: var(--ok); }
    .chip-yellow { color: var(--warn); border-color: var(--warn); }
    .chip-red { color: var(--bad); border-color: var(--bad); }
    /* â”€â”€ KPI â”€â”€ */
    .kpi { font-size: 28px; font-weight: 700; }
    .kpi-label { font-size: 12px; color: var(--muted); }
    .kpi-row { display: flex; gap: 16px; flex-wrap: wrap; }
    .kpi-box { flex: 1; min-width: 80px; }
    /* â”€â”€ Set buttons (touch-friendly) â”€â”€ */
    .set-btns {
      display: flex; gap: 6px; flex-wrap: wrap;
    }
    .set-btn {
      min-width: 56px; height: 56px; border-radius: var(--radius-sm);
      border: 2px solid var(--border2); background: var(--card);
      color: var(--txt); font-size: 20px; font-weight: 700;
      display: flex; align-items: center; justify-content: center;
      cursor: pointer; transition: all 0.1s; flex: 1;
    }
    .set-btn:active, .set-btn.selected {
      background: var(--acc); border-color: var(--acc); color: #fff;
      transform: scale(0.95);
    }
    .set-btn-vara { font-size: 15px; }
    /* â”€â”€ Readiness indicator â”€â”€ */
    .readiness-dot {
      width: 14px; height: 14px; border-radius: 50%; display: inline-block;
    }
    .readiness-dot.green { background: var(--ok); }
    .readiness-dot.yellow { background: var(--warn); }
    .readiness-dot.red { background: var(--bad); }
    .readiness-dot.none { background: var(--dim); }
    /* â”€â”€ Progress bar â”€â”€ */
    .progress { height: 4px; background: var(--border); border-radius: 2px; overflow: hidden; margin: 8px 0; }
    .progress-fill { height: 100%; background: var(--acc); transition: width 0.3s; }
    /* â”€â”€ Table â”€â”€ */
    table { width: 100%; border-collapse: collapse; font-size: 13px; }
    th, td { padding: 8px 6px; text-align: left; border-bottom: 1px solid var(--border); }
    th { color: var(--muted); font-weight: 600; font-size: 11px; text-transform: uppercase; }
    /* â”€â”€ Accordion â”€â”€ */
    .accordion-header {
      display: flex; justify-content: space-between; align-items: center;
      padding: 10px 0; cursor: pointer; color: var(--muted); font-size: 13px;
    }
    .accordion-body { display: none; padding: 8px 0; }
    .accordion-body.open { display: block; }
    /* â”€â”€ Helpers â”€â”€ */
    .muted { color: var(--muted); font-size: 12px; }
    .dim { color: var(--dim); }
    .text-ok { color: var(--ok); }
    .text-warn { color: var(--warn); }
    .text-bad { color: var(--bad); }
    .text-center { text-align: center; }
    .mt { margin-top: 12px; }
    .mb { margin-bottom: 12px; }
    .hidden { display: none !important; }
    .flex-between { display: flex; justify-content: space-between; align-items: center; }
    .gap-sm { gap: 6px; }
    .fade-in { animation: fadeIn 0.2s ease-in; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
    /* â”€â”€ Notification toast â”€â”€ */
    .toast {
      position: fixed; top: 12px; left: 50%; transform: translateX(-50%);
      background: var(--card2); border: 1px solid var(--border2);
      border-radius: var(--radius); padding: 12px 20px; z-index: 200;
      font-size: 14px; max-width: 90%; text-align: center;
      animation: fadeIn 0.2s ease-in;
    }
    .toast.warn { border-color: var(--warn); }
    .toast.bad { border-color: var(--bad); }
    .toast.ok { border-color: var(--ok); }
    /* â”€â”€ Section header â”€â”€ */
    .section-header { font-size: 18px; font-weight: 700; margin: 16px 0 10px; }
    /* â”€â”€ Exercise card in workout â”€â”€ */
    .exercise-card {
      background: var(--card); border: 1px solid var(--border);
      border-radius: var(--radius); padding: 14px; margin-bottom: 10px;
    }
    .exercise-name {
      font-size: 16px; font-weight: 700; margin-bottom: 4px;
      cursor: pointer;
    }
    .exercise-meta { font-size: 12px; color: var(--muted); }
    .set-row {
      display: flex; align-items: center; gap: 8px; padding: 8px 0;
      border-bottom: 1px solid var(--border);
    }
    .set-row:last-child { border-bottom: none; }
    .set-number { font-size: 12px; color: var(--dim); width: 24px; text-align: center; }
    .load-display {
      background: var(--card2); border: 1px solid var(--border2); border-radius: var(--radius);
      padding: 14px 20px; font-weight: 700; font-size: 22px;
      cursor: pointer; min-width: 100px; text-align: center;
      display: inline-block;
    }
    .load-display:active { background: var(--border); }
    .load-up { color: var(--ok); border-color: var(--ok); }
    /* â”€â”€ Program slot â”€â”€ */
    .program-slot {
      display: flex; justify-content: space-between; align-items: center;
      padding: 10px 0; border-bottom: 1px solid var(--border);
    }
    .program-slot:last-child { border-bottom: none; }
    .program-slot-num { color: var(--dim); font-size: 13px; width: 20px; }
    .program-slot-name { font-weight: 600; font-size: 14px; flex: 1; }
    .program-slot-detail { text-align: right; font-size: 13px; }
    .program-slot-load { font-weight: 700; color: var(--acc); }
    .program-slot-sets { color: var(--muted); }
    /* â”€â”€ Scrollable â”€â”€ */
    .scroll-x { overflow-x: auto; -webkit-overflow-scrolling: touch; }
    /* â”€â”€ Workout set buttons row â”€â”€ */
    .set-btns-row {
      display: grid; grid-template-columns: repeat(5, 1fr); gap: 6px;
    }
    @media (max-width: 360px) {
      .set-btns-row { grid-template-columns: repeat(4, 1fr); }
    }
  </style>
</head>
<body>

<div class="app" id="app"></div>

<nav class="nav" id="nav"></nav>

<div id="toast-container"></div>

<script type="module">
import {
  initDB, uid, todayISO, parseNumericInput,
  getAllMovements, getMovementsByCategory, getPrimaryMovement, addMovement, deleteMovement,
  getVariantsForMovement, getVariantByName, getAllVariants,
  getAllSessions, getSession, saveSession, deleteSession,
  getSetsForSession, getAllSets, saveSet, saveSets, deleteSet,
  saveMeasurement, getMeasurementsByType,
  getActiveMesocycle, saveMesocycle, createDefaultMesocycle, createPeakingMesocycle, getAllMesocycles,
  getSettings, saveSettings,
  exportFullBackup, importFullBackup,
  parseCSV, importHistoricalCSV,
  getMovementProgress, getAllMovementProgress, saveMovementProgress,
  getTracesForRec,
  CATEGORIES, PULL_VOLUME_CATEGORIES, VARIANT_DAY_TYPE_MAP,
  validateVelocity, validateLoad, validateReps, validateHRV, validateBodyweight,
  isVelocityTypo,
} from "./data.js";

import {
  recommend, e1rmSystem, e1rmExternal, e1rmAccessory,
  ouraHRVtoLnRMSSD,
  velocityReadiness, hrvReadiness, varaReadiness, combineReadiness,
  computeBaseline, median, avg, roundToHalf,
  failureReaction,
  accessoryProgression, updateMovementProgressFromSets, initialWeightFrom1RM,
  velocityLossPercent,
  weeklyStimulus, checkStagnation,
  getMesocycleWeek, getWeekDef, getTodayPlan,
  breakAnalysis, speedDayLoad,
  varaFeedback,
  analyzeSessionAdaptation, applyAdaptations,
  getFutureWorkouts,
  eliteVolumeCheck,
  computeMovementE1RM, computeMovementE1RMHistory,
  REST_RECOMMENDATIONS,
  variantLoadModifier, variantRepOverride, assignVariantRotation,
  computeAttemptLoads,
} from "./engine.js";

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// APP STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const state = {
  view: "dashboard",
  settings: null,
  movements: [],
  sessions: [],
  allSets: [],
  mesocycle: null,
  recommendation: null,
  readiness: { combined: "GREEN", capLevel: 0, channels: {} },
  // Active workout state
  workout: null, // { sessionId, dayType, exercises: [...], currentExerciseIdx, currentSetIdx, startedAt }
  // HRV & velocity readiness inputs for today
  todayHRV: null,
  todayVelocity: null,
  // Adaptation history for volume optimization
  adaptationHistory: [],
  // Rest timer
  restTimerInterval: null,
  restTimerSeconds: 0,
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INITIALIZATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function init() {
  await initDB();
  state.settings = await getSettings();
  state.movements = await getAllMovements();
  state.sessions = await getAllSessions();
  state.allSets = await getAllSets();
  state.mesocycle = await getActiveMesocycle();
  if (!state.mesocycle) {
    state.mesocycle = createDefaultMesocycle(todayISO());
    assignVariantRotation(state.mesocycle.weekPlans);
    await saveMesocycle(state.mesocycle);
  } else if (state.mesocycle.type !== "peaking") {
    // Migrate existing mesocycle: add variants if missing
    const hasVariants = state.mesocycle.weekPlans?.some(wp =>
      wp.days?.some(d => d.slots?.some(s => s.variantName))
    );
    if (!hasVariants && state.mesocycle.weekPlans) {
      assignVariantRotation(state.mesocycle.weekPlans);
      await saveMesocycle(state.mesocycle);
    }
  }
  await computeReadiness();
  await computeRecommendation();
  render();
}

async function refresh() {
  state.movements = await getAllMovements();
  state.sessions = await getAllSessions();
  state.allSets = await getAllSets();
  state.mesocycle = await getActiveMesocycle();
  await computeReadiness();
  await computeRecommendation();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// READINESS COMPUTATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function computeReadiness() {
  const settings = state.settings;
  const bw = settings.bodyweightKg || 91;

  // Velocity baseline: readiness test velocities
  const readinessTestSets = state.allSets
    .filter(s => s.setRole === "readiness_test" && s.velocityRep1 !== null)
    .sort((a, b) => (a.timestamp || "").localeCompare(b.timestamp || ""));
  const velValues = readinessTestSets.map(s => s.velocityRep1);
  const velR = velocityReadiness(state.todayVelocity, velValues, settings.readinessVelocityWindowN || 10);

  // HRV baseline
  const hrvMeasurements = await getMeasurementsByType("HRV");
  const lnRmssdValues = hrvMeasurements
    .sort((a, b) => (a.dateISO || "").localeCompare(b.dateISO || ""))
    .map(m => m.valueTransformed)
    .filter(v => v !== null && v !== undefined);
  const todayLn = state.todayHRV ? ouraHRVtoLnRMSSD(state.todayHRV) : null;
  const hrvR = hrvReadiness(todayLn, lnRmssdValues, settings.readinessHrvWindowN || 14);

  // Vara baseline: recent top sets
  const topSets = state.allSets
    .filter(s => s.setRole === "top" && s.actualVx !== null)
    .sort((a, b) => (a.timestamp || "").localeCompare(b.timestamp || ""));
  const varaR = varaReadiness(topSets, settings.readinessVaraWindowN || 5);

  state.readiness = combineReadiness(velR, hrvR, varaR);
}

async function computeRecommendation() {
  const settings = state.settings;
  const primaryMov = state.movements.find(m => m.isPrimary);
  state.recommendation = await recommend({
    settings,
    bodyweightKg: settings.bodyweightKg || 91,
    dateISO: todayISO(),
    mesocycle: state.mesocycle,
    sessions: state.sessions,
    allSets: state.allSets,
    readiness: state.readiness,
    primaryMovementId: primaryMov?.movementId || null,
    dryRun: true,
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TOAST NOTIFICATIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function showToast(message, type = "", duration = 3000) {
  const container = document.getElementById("toast-container");
  const toast = document.createElement("div");
  toast.className = `toast ${type}`;
  toast.textContent = message;
  container.appendChild(toast);
  setTimeout(() => toast.remove(), duration);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DATE HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function formatDate(iso) {
  if (!iso) return "-";
  try {
    const d = new Date(iso);
    return d.toLocaleDateString("fi-FI", { timeZone: "Europe/Helsinki", weekday: "short", day: "numeric", month: "numeric", year: "numeric" });
  } catch { return iso; }
}

function formatDateShort(iso) {
  if (!iso) return "-";
  try {
    const d = new Date(iso);
    return d.toLocaleDateString("fi-FI", { timeZone: "Europe/Helsinki", weekday: "short", day: "numeric", month: "numeric" });
  } catch { return iso; }
}

function dayOfWeekFi(iso) {
  if (!iso) return "";
  const days = ["Su", "Ma", "Ti", "Ke", "To", "Pe", "La"];
  return days[new Date(iso).getDay()];
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function render() {
  const app = document.getElementById("app");
  switch (state.view) {
    case "dashboard": app.innerHTML = renderDashboard(); break;
    case "workout": app.innerHTML = renderWorkout(); break;
    case "readiness": app.innerHTML = renderReadiness(); break;
    case "mesocycle": app.innerHTML = renderMesocycle(); break;
    case "movements": app.innerHTML = renderMovements(); break;
    case "history": app.innerHTML = renderHistory(); break;
    case "trends": app.innerHTML = renderTrends(); break;
    case "settings": app.innerHTML = renderSettingsView(); break;
    default: app.innerHTML = renderDashboard();
  }
  renderNav();
  bind();
}

function renderNav() {
  const navItems = [
    { id: "dashboard", icon: "ğŸ ", label: "Koti" },
    { id: "mesocycle", icon: "ğŸ“…", label: "Sykli" },
    { id: "movements", icon: "ğŸ’ª", label: "Liikkeet" },
    { id: "history", icon: "ğŸ“Š", label: "Historia" },
    { id: "settings", icon: "âš™ï¸", label: "Asetukset" },
  ];
  document.getElementById("nav").innerHTML = navItems.map(n =>
    `<button data-nav="${n.id}" class="${state.view === n.id ? 'active' : ''}">
      <span class="icon">${n.icon}</span>${n.label}
    </button>`
  ).join("");
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DASHBOARD VIEW
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function renderDashboard() {
  const rec = state.recommendation;
  const r = state.readiness;
  const today = todayISO();
  const weekNum = rec?.weekNum || "?";
  const weekLabel = rec?.weekLabel || "";
  const dayType = rec?.dayType || "heavy";
  const mesoNum = state.mesocycle ? (state.sessions.length > 0 ? Math.ceil(state.sessions.length / 12) : 1) : 1;

  // Day type labels in Finnish
  const dayTypeLabels = { heavy: "Heavy", volume: "Volume", speed: "Speed", competition: "Kilpailu", rest: "Lepo" };
  const isPeaking = rec?.mesocycleType === "peaking";

  // Readiness badge
  const readinessClass = r.combined === "GREEN" ? "chip-green" : r.combined === "YELLOW" ? "chip-yellow" : "chip-red";
  const readinessEmoji = r.combined === "GREEN" ? "ğŸŸ¢" : r.combined === "YELLOW" ? "ğŸŸ¡" : "ğŸ”´";

  // Build program preview â€” always shows full program with accessories
  let programHTML = "";
  if (rec && rec.dayPlan && rec.dayPlan.slots && rec.dayPlan.slots.length > 0) {
    programHTML = rec.dayPlan.slots.map((slot, i) => {
      const movName = slot.defaultMovementName || slot.category;
      const isPrimary = slot.role === "primary";
      const isBackoff = slot.role === "backoff";
      const isAttempt = ["warmup", "opener", "attempt2", "attempt3"].includes(slot.role);
      let loadStr = "";
      if (isAttempt && rec.attemptLoads) {
        const loads = rec.attemptLoads;
        if (slot.role === "warmup") loadStr = `<span class="program-slot-load" style="color:var(--muted)">LÃ¤mmittely</span>`;
        else if (slot.role === "opener") loadStr = `<span class="program-slot-load" style="color:var(--ok)">+${loads.opener} kg</span>`;
        else if (slot.role === "attempt2") loadStr = `<span class="program-slot-load" style="color:var(--warn)">+${loads.second} kg</span>`;
        else if (slot.role === "attempt3") loadStr = `<span class="program-slot-load" style="color:var(--bad)">+${loads.third} kg ğŸ¯</span>`;
      } else if (isPrimary && rec.targetExternalLoad !== null) {
        loadStr = `<span class="program-slot-load">+${rec.targetExternalLoad} kg</span>`;
      } else if (isBackoff && rec.targetExternalLoad !== null) {
        loadStr = `<span class="program-slot-load" style="color:var(--muted)">+${roundToHalf(rec.targetExternalLoad * 0.85)} kg</span>`;
      }
      const setsReps = `${slot.sets}Ã—${slot.reps}`;
      const vxStr = slot.targetVx !== null ? ` V${slot.targetVx}` : "";
      const icon = isPrimary ? "â­ " : isBackoff ? "â†© " : isAttempt ? "ğŸ† " : "";
      const variantStr = slot.variantName && (isPrimary || isBackoff) ? `<div class="muted" style="font-size:11px">${slot.variantName}</div>` : "";
      return `<div class="program-slot">
        <span class="program-slot-num">${i + 1}.</span>
        <span class="program-slot-name">${icon}${movName}${variantStr}</span>
        <div class="program-slot-detail">
          <span class="program-slot-sets">${setsReps}${vxStr}</span><br>
          ${loadStr}
        </div>
      </div>`;
    }).join("");
  } else {
    programHTML = '<div class="muted">Ei ohjelmaa â€” aloita mesosykli</div>';
  }

  // Break warning
  let breakHTML = "";
  if (rec?.breakInfo) {
    breakHTML = `<div class="card" style="border-color:var(--warn)">
      <div class="text-warn" style="font-weight:600">${rec.breakInfo.message}</div>
    </div>`;
  }

  // e1RM display
  const e1rmExt = rec?.e1rmExternal !== null ? rec.e1rmExternal?.toFixed(1) : "-";
  const e1rmSys = rec?.e1rmSystem !== null ? rec.e1rmSystem?.toFixed(1) : "-";

  // Vara feedback
  let varaHTML = "";
  if (rec?.varaFeedback?.suggestion) {
    const type = rec.varaFeedback.type === "too_easy" ? "text-ok" : "text-warn";
    varaHTML = `<div class="muted mt ${type}">${rec.varaFeedback.suggestion}</div>`;
  }

  return `<div class="fade-in">
    <div class="flex-between mb">
      <div>
        <div style="font-size:13px;color:var(--muted)">${formatDate(today)}</div>
        <div style="font-size:20px;font-weight:700">${dayTypeLabels[dayType] || dayType}</div>
        <div class="muted">Viikko ${weekNum} / ${weekLabel}</div>
      </div>
      <div style="display:flex;flex-direction:column;gap:4px;align-items:flex-end">
        ${isPeaking ? '<div class="chip" style="color:var(--warn);border-color:var(--warn);font-size:11px">ğŸ† PEAKING</div>' : ''}
        <div class="chip ${readinessClass}">${readinessEmoji} ${r.combined || "?"}</div>
      </div>
    </div>

    ${breakHTML}

    <div class="card">
      <div class="kpi-row">
        <div class="kpi-box">
          <div class="kpi">${e1rmExt}</div>
          <div class="kpi-label">e1RM lisÃ¤paino (kg)</div>
        </div>
        <div class="kpi-box">
          <div class="kpi">${e1rmSys}</div>
          <div class="kpi-label">e1RM system (kg)</div>
        </div>
      </div>
      ${varaHTML}
    </div>

    <button class="btn btn-big btn-full mb" id="btn-start-workout">
      â–¶ ALOITA TREENI
    </button>

    <button class="btn btn-outline btn-full mb" id="btn-readiness" style="font-size:14px">
      ğŸ“Š SyÃ¶tÃ¤ readiness (HRV / velocity)
    </button>

    <div class="card">
      <div class="card-title">PÃ¤ivÃ¤n ohjelma</div>
      ${programHTML || '<div class="muted">Ei ohjelmaa â€” aloita mesosykli</div>'}
    </div>

    ${renderDecisionTracePreview(rec)}

    ${renderWeeklyOverview()}

    ${renderEliteWarnings()}

    ${renderFutureWorkoutsPreview()}
  </div>`;
}

function renderDecisionTracePreview(rec) {
  if (!rec || !rec.traces || !rec.traces.length) return "";
  return `<div class="card">
    <div class="accordion-header" data-toggle="trace-preview">
      <span class="card-title" style="margin:0">Miksi tÃ¤mÃ¤ suositus?</span>
      <span>â–¼</span>
    </div>
    <div class="accordion-body" id="trace-preview">
      ${rec.traces.map(t => `<div style="padding:4px 0;border-bottom:1px solid var(--border);font-size:12px">
        <span style="color:var(--acc)">${t.ruleId}</span>: ${t.why}
      </div>`).join("")}
    </div>
  </div>`;
}

function renderWeeklyOverview() {
  // Simplified weekly stimulus
  const weekStart = new Date();
  weekStart.setDate(weekStart.getDate() - weekStart.getDay() + 1);
  const weekStartISO = weekStart.toISOString().slice(0, 10);

  const weekSets = state.allSets.filter(s => {
    const session = state.sessions.find(ses => ses.sessionId === s.sessionId);
    return session && session.dateISO >= weekStartISO;
  });

  const stimulus = weeklyStimulus(weekSets, state.movements);

  return `<div class="card">
    <div class="card-title">Viikon stimulus</div>
    <div class="kpi-row">
      <div class="kpi-box">
        <div class="kpi">${stimulus.pullVolumeSets}</div>
        <div class="kpi-label">Vetosarjat</div>
      </div>
      <div class="kpi-box">
        <div class="kpi">${stimulus.heavyExposures}</div>
        <div class="kpi-label">Heavy altistukset</div>
      </div>
      <div class="kpi-box">
        <div class="kpi">${Math.round(stimulus.totalTonnageExternal)}</div>
        <div class="kpi-label">Tonnage (kg)</div>
      </div>
    </div>
  </div>`;
}

function renderEliteWarnings() {
  const weekStart = new Date();
  weekStart.setDate(weekStart.getDate() - weekStart.getDay() + 1);
  const weekStartISO = weekStart.toISOString().slice(0, 10);
  const weekSets = state.allSets.filter(s => {
    const session = state.sessions.find(ses => ses.sessionId === s.sessionId);
    return session && session.dateISO >= weekStartISO;
  });
  const check = eliteVolumeCheck(weekSets, state.movements);
  if (check.warnings.length === 0) return "";
  return `<div class="card" style="border-color:var(--warn)">
    <div class="card-title">âš¡ Eliittitason huomiot</div>
    ${check.warnings.map(w => `<div class="muted text-warn" style="padding:4px 0">âš  ${w.message}</div>`).join("")}
  </div>`;
}

function renderFutureWorkoutsPreview() {
  if (!state.mesocycle) return "";
  const futureWorkouts = getFutureWorkouts(state.mesocycle, todayISO(), 14);
  if (futureWorkouts.length === 0) return "";
  const dayNames = { 1: "Ma", 2: "Ti", 3: "Ke", 4: "To", 5: "Pe", 6: "La", 7: "Su" };
  return `<div class="card">
    <div class="card-title">ğŸ“… Tulevat treenit</div>
    ${futureWorkouts.slice(0, 5).map(fw => `<div class="program-slot" style="flex-direction:column;align-items:stretch;gap:4px">
      <div class="flex-between">
        <span style="font-weight:600">${dayNames[fw.dayOfWeek]} ${fw.dateISO.slice(5)}</span>
        <span class="muted">${fw.dayType} â€” Vk ${fw.weekNum} ${fw.weekLabel}</span>
      </div>
      <div class="muted">${fw.slots.map(s => {
        const icon = s.role === "primary" ? "â­" : s.role === "backoff" ? "â†©" : ["warmup","opener","attempt2","attempt3"].includes(s.role) ? "ğŸ†" : "â€¢";
        const vName = s.variantName ? ` (${s.variantName.split(" ")[0]})` : "";
        return `${icon} ${s.defaultMovementName}${vName} ${s.sets}Ã—${s.reps}`;
      }).join(" | ")}</div>
    </div>`).join("")}
    <button class="btn btn-sm btn-outline btn-full mt" data-nav="mesocycle">NÃ¤ytÃ¤ kaikki â†’</button>
  </div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// READINESS VIEW
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function renderReadiness() {
  const r = state.readiness;
  const ch = r.channels || {};

  function channelRow(label, channel) {
    if (!channel || channel.class === null) return `<div class="flex-between" style="padding:8px 0"><span>${label}</span><span class="dim">Ei dataa</span></div>`;
    const dot = channel.class === "GREEN" ? "green" : channel.class === "YELLOW" ? "yellow" : "red";
    const zStr = channel.z !== null ? `z=${channel.z.toFixed(2)}` : "";
    return `<div class="flex-between" style="padding:8px 0;border-bottom:1px solid var(--border)">
      <span>${label}</span>
      <span><span class="readiness-dot ${dot}"></span> ${channel.class} ${zStr}</span>
    </div>`;
  }

  return `<div class="fade-in">
    <div class="section-header">Readiness</div>

    <div class="card">
      <label>HRV (Oura, ms)</label>
      <input type="number" inputmode="decimal" id="input-hrv" value="${state.todayHRV || ""}" placeholder="esim. 45">
      <div class="muted mt">YÃ¶n keskiarvo-HRV RMSSD millisekunteina</div>
    </div>

    <div class="card">
      <label>Readiness-testi velocity (m/s)</label>
      <input type="number" inputmode="decimal" step="0.01" id="input-vel" value="${state.todayVelocity || ""}" placeholder="esim. 0.53">
      <div class="muted mt">1. repin mean velocity readiness-testistÃ¤ (+40 kg Ã— 2, max intent)</div>
    </div>

    <button class="btn btn-full mb" id="btn-save-readiness">Tallenna readiness</button>

    <div class="card">
      <div class="card-title">Kanavat</div>
      ${channelRow("Velocity", ch.velocity)}
      ${channelRow("HRV", ch.hrv)}
      ${channelRow("Vara", ch.vara)}
      <div class="flex-between mt" style="padding:8px 0;font-weight:700">
        <span>Kokonaistila</span>
        <span class="chip ${r.combined === 'GREEN' ? 'chip-green' : r.combined === 'YELLOW' ? 'chip-yellow' : 'chip-red'}">${r.combined || "?"}</span>
      </div>
    </div>

    <button class="btn btn-outline btn-full" data-nav="dashboard">â† Takaisin</button>
  </div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// WORKOUT VIEW
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function renderWorkout() {
  if (!state.workout) return renderWorkoutSetup();
  return renderActiveWorkout();
}

function renderWorkoutSetup() {
  const rec = state.recommendation;
  const dayType = rec?.dayType || "heavy";
  return `<div class="fade-in">
    <div class="section-header">Treeni</div>
    <div class="card">
      <div style="font-size:16px;font-weight:600">${formatDate(todayISO())} â€” ${dayType}</div>
      <div class="muted">Viikko ${rec?.weekNum || "?"} / ${rec?.weekLabel || ""}</div>
    </div>
    <button class="btn btn-big btn-full" id="btn-begin-workout">â–¶ ALOITA TREENI</button>
  </div>`;
}

function renderActiveWorkout() {
  const w = state.workout;
  if (!w) return "";

  const totalExercises = w.exercises.length;
  const currentExIdx = w.currentExerciseIdx;
  const exercise = w.exercises[currentExIdx];
  if (!exercise) return renderWorkoutSummary();

  const totalSets = exercise.sets.length;
  const currentSetIdx = w.currentSetIdx;
  const currentSet = exercise.sets[currentSetIdx];

  if (!currentSet) {
    // Move to next exercise
    return renderWorkoutExerciseComplete(exercise);
  }

  const progressPct = ((currentExIdx * 100 + (currentSetIdx / totalSets) * 100) / totalExercises).toFixed(0);

  // Load display
  const loadStr = currentSet.loadKg !== null ? `${currentSet.loadKg} kg` : "â€“";
  const isLoadIncrease = exercise.progressSuggestion === "increase";

  // Rest time recommendation
  const restRec = exercise.role === "primary" || exercise.role === "backoff"
    ? REST_RECOMMENDATIONS[state.workout.dayType] || REST_RECOMMENDATIONS.heavy
    : REST_RECOMMENDATIONS.accessory;

  // Rest timer display
  const restTimerHTML = state.restTimerSeconds > 0
    ? `<div id="rest-timer-display" style="text-align:center;margin:8px 0;font-size:24px;font-weight:700;color:var(--acc)">${formatRestTime(state.restTimerSeconds)}<div class="muted" style="font-size:11px;font-weight:400">Suositus: ${restRec.label}</div></div>`
    : `<div id="rest-timer-display" style="text-align:center;margin:8px 0;font-size:24px;font-weight:700;color:var(--acc);display:none"></div>`;

  // Completed sets summary for this exercise
  const completedSetsHTML = exercise.sets.filter(s => s.completed).map((s, i) =>
    `<div class="muted" style="padding:2px 0;font-size:12px">âœ“ Sarja ${i + 1}: ${s.loadKg} kg Ã— ${s.reps} V${s.actualVx ?? "?"} ${s.velocity ? `(${s.velocity} m/s)` : ""}</div>`
  ).join("");

  // Exercise list sidebar
  const exerciseListHTML = w.exercises.map((ex, i) => {
    const done = ex.sets.every(s => s.completed);
    const active = i === currentExIdx;
    return `<span style="display:inline-block;padding:4px 8px;border-radius:6px;font-size:11px;margin:2px;${active ? 'background:var(--acc);color:#fff' : done ? 'background:var(--ok2);color:var(--ok)' : 'background:var(--card2);color:var(--muted)'}">${i + 1}. ${ex.name.split(" ")[0]}</span>`;
  }).join("");

  return `<div class="fade-in">
    <div class="flex-between mb">
      <div class="muted">${currentExIdx + 1}/${totalExercises} liikettÃ¤</div>
      <div>
        <button class="btn btn-sm btn-outline" id="btn-skip-exercise" style="margin-right:4px">â© Ohita</button>
        <button class="btn btn-sm btn-outline" id="btn-end-workout">ğŸ Lopeta</button>
      </div>
    </div>
    <div class="progress"><div class="progress-fill" style="width:${progressPct}%"></div></div>
    <div class="scroll-x" style="margin:8px 0">${exerciseListHTML}</div>

    <div class="exercise-card">
      <div class="flex-between">
        <div>
          <div class="exercise-name" id="btn-swap-exercise">ğŸ”„ ${exercise.name}</div>
          <div class="exercise-meta">
            ${exercise.role === "primary" ? "â­ PÃ¤Ã¤liike" : exercise.role === "backoff" ? "â†© Back-off" : ["warmup","opener","attempt2","attempt3"].includes(exercise.role) ? "ğŸ† " + (exercise.role === "warmup" ? "LÃ¤mmittely" : exercise.role === "opener" ? "1. yritys" : exercise.role === "attempt2" ? "2. yritys" : "3. yritys") : exercise.category}
            ${isLoadIncrease ? ' <span class="text-ok">â†‘ Progressio</span>' : ""}
          </div>
          ${exercise.variantName ? `<div class="muted" style="font-size:11px;margin-top:2px">ğŸ”€ ${exercise.variantName}${exercise.tempoNote ? ` â€” <strong>${exercise.tempoNote}</strong>` : ""}</div>` : ""}
        </div>
      </div>

      ${completedSetsHTML ? `<div style="margin-top:8px;padding:8px;background:var(--card2);border-radius:var(--radius-sm)">${completedSetsHTML}</div>` : ""}

      ${restTimerHTML}

      <div style="margin-top:12px">
        <div class="flex-between">
          <span class="muted">Sarja ${currentSetIdx + 1}/${totalSets}</span>
          <span class="muted">Tavoite: ${currentSet.targetReps} Ã— V${currentSet.targetVx ?? "?"}</span>
        </div>

        <div style="text-align:center;margin:16px 0">
          <div id="btn-edit-load" class="load-display ${isLoadIncrease ? 'load-up' : ''}">${loadStr}</div>
          <div class="muted mt">Napauta muokataksesi painoa</div>
        </div>

        <label>Toistot</label>
        <div class="set-btns-row" id="reps-btns">
          ${[1,2,3,4,5,6,7,8,9,10].map(n =>
            `<button class="set-btn" data-reps="${n}">${n}</button>`
          ).join("")}
        </div>

        <label style="margin-top:14px">Vara (etÃ¤isyys failureen)</label>
        <div class="set-btns-row" id="vara-btns">
          ${[0,1,2,3,4,5].map(n =>
            `<button class="set-btn set-btn-vara" data-vara="${n}">V${n}</button>`
          ).join("")}
        </div>

        <label style="margin-top:14px">Velocity (valinnainen)</label>
        <input type="number" inputmode="decimal" step="0.01" id="input-set-velocity" placeholder="Setin mean velocity m/s">
      </div>

      <button class="btn btn-full mt" id="btn-next-set" disabled>â†’ Seuraava sarja</button>
      <button class="btn btn-outline btn-full mt" id="btn-add-set" style="font-size:13px">+ LisÃ¤sarja</button>
    </div>

    ${(exercise.role === "primary" || exercise.role === "backoff") && exercise.category === "vertikaaliveto" ? '<button class="btn btn-outline btn-full mt" id="btn-swap-variant" style="font-size:13px">ğŸ”€ Vaihda variaatio</button>' : ""}
    <button class="btn btn-outline btn-full mt" id="btn-add-exercise" style="font-size:14px">+ LisÃ¤Ã¤ liike</button>
  </div>`;
}

function formatRestTime(seconds) {
  const m = Math.floor(seconds / 60);
  const s = seconds % 60;
  return `${m}:${s < 10 ? "0" : ""}${s}`;
}

function startRestTimer() {
  stopRestTimer();
  state.restTimerSeconds = 0;
  state.restTimerInterval = setInterval(() => {
    state.restTimerSeconds++;
    const el = document.getElementById('rest-timer-display');
    if (el) {
      el.textContent = formatRestTime(state.restTimerSeconds);
      el.style.display = '';
    }
  }, 1000);
}

function stopRestTimer() {
  if (state.restTimerInterval) {
    clearInterval(state.restTimerInterval);
    state.restTimerInterval = null;
  }
  state.restTimerSeconds = 0;
}

function renderWorkoutExerciseComplete(exercise) {
  return `<div class="fade-in">
    <div class="card text-center">
      <div style="font-size:24px;margin-bottom:8px">âœ“</div>
      <div style="font-weight:600">${exercise.name} valmis</div>
    </div>
    <button class="btn btn-full" id="btn-next-exercise">Seuraava liike â†’</button>
  </div>`;
}

function renderWorkoutSummary() {
  const w = state.workout;
  if (!w) return "";

  const totalSets = w.exercises.reduce((sum, ex) => sum + ex.sets.filter(s => s.completed).length, 0);
  const bw = state.settings?.bodyweightKg || 91;
  const totalTonnageExt = w.exercises.reduce((sum, ex) =>
    sum + ex.sets.filter(s => s.completed).reduce((ss, s) => ss + (s.loadKg || 0) * (s.reps || 0), 0), 0);
  // System tonnage includes bodyweight for primary/backoff movements
  const totalTonnageSys = w.exercises.reduce((sum, ex) => {
    const isPull = ex.role === "primary" || ex.role === "backoff";
    return sum + ex.sets.filter(s => s.completed).reduce((ss, s) => {
      const load = isPull ? (bw + (s.loadKg || 0)) : (s.loadKg || 0);
      return ss + load * (s.reps || 0);
    }, 0);
  }, 0);

  // Adaptation preview
  const rec = state.recommendation;
  let adaptationPreview = "";
  if (rec?.dayPlan?.slots) {
    const adaptations = analyzeSessionAdaptation(w.exercises, rec.dayPlan.slots);
    if (adaptations.length > 0) {
      adaptationPreview = `<div class="card" style="border-color:var(--acc)">
        <div class="card-title">ğŸ§  Adaptiivinen analyysi</div>
        ${adaptations.map(a => `<div class="muted" style="padding:4px 0">${a.type === "volume_up" ? "ğŸ“ˆ" : a.type === "volume_down" ? "ğŸ“‰" : "â•"} ${a.reason}</div>`).join("")}
      </div>`;
    }
  }

  return `<div class="fade-in">
    <div class="card text-center">
      <div style="font-size:48px;margin-bottom:12px">ğŸ’ª</div>
      <div style="font-size:20px;font-weight:700">Treeni valmis!</div>
      <div class="kpi-row mt">
        <div class="kpi-box"><div class="kpi">${totalSets}</div><div class="kpi-label">Sarjat</div></div>
        <div class="kpi-box"><div class="kpi">${Math.round(totalTonnageSys)}</div><div class="kpi-label">Tonnage sys</div></div>
        <div class="kpi-box"><div class="kpi">${Math.round(totalTonnageExt)}</div><div class="kpi-label">Tonnage lisÃ¤p.</div></div>
      </div>
    </div>

    ${w.exercises.map(ex => {
      const completedSets = ex.sets.filter(s => s.completed);
      if (completedSets.length === 0) return "";
      const isPri = ex.role === "primary" || ex.role === "backoff";
      const exE1RM = isPri
        ? e1rmExternal(bw, completedSets[0].loadKg || 0, completedSets[0].reps || 3, completedSets[0].actualVx ?? 2)
        : e1rmAccessory(completedSets[0].loadKg || 0, completedSets[0].reps || 3);
      const isAttempt = ["warmup","opener","attempt2","attempt3"].includes(ex.role);
      const icon = ex.role === "primary" ? "â­ " : ex.role === "backoff" ? "â†© " : isAttempt ? "ğŸ† " : "";
      const attemptLabel = isAttempt ? ` (${ex.role === "warmup" ? "LÃ¤mmittely" : ex.role === "opener" ? "1. yritys" : ex.role === "attempt2" ? "2. yritys" : "3. yritys"})` : "";
      return `<div class="card">
        <div class="flex-between">
          <div style="font-weight:600">${icon}${ex.name}${attemptLabel}</div>
          ${exE1RM !== null ? `<span class="muted">e1RM: ${exE1RM.toFixed(1)} kg</span>` : ""}
        </div>
        ${completedSets.map(s =>
          `<div class="muted">${s.loadKg} kg Ã— ${s.reps} @ V${s.actualVx ?? "?"} ${s.velocity ? `(${s.velocity} m/s)` : ""}</div>`
        ).join("")}
      </div>`;
    }).join("")}

    ${adaptationPreview}

    <button class="btn btn-ok btn-full mb" id="btn-save-workout">ğŸ’¾ Tallenna treeni</button>
    <button class="btn btn-outline btn-full" id="btn-discard-workout">HylkÃ¤Ã¤</button>
  </div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MESOCYCLE VIEW
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function renderMesocycle() {
  const meso = state.mesocycle;
  if (!meso) return `<div class="fade-in"><div class="section-header">Mesosykli</div><div class="card"><div class="muted">Ei aktiivista mesosykliÃ¤</div><button class="btn btn-full mt" id="btn-new-meso">Aloita uusi mesosykli</button></div></div>`;

  const currentWeek = getMesocycleWeek(meso, todayISO());
  const dayNames = { 1: "Ma", 2: "Ti", 3: "Ke", 4: "To", 5: "Pe", 6: "La", 7: "Su" };
  const futureWorkouts = getFutureWorkouts(meso, todayISO(), 28);

  return `<div class="fade-in">
    <div class="section-header">Mesosykli</div>

    <div class="card">
      <div class="flex-between">
        <div>
          <div style="font-weight:600">Aloitus: ${formatDateShort(meso.startDateISO)}</div>
          <div class="muted">${meso.weekCount} viikkoa</div>
        </div>
        <div style="display:flex;gap:4px;align-items:center">
          ${meso.type === "peaking" ? '<span class="chip" style="color:var(--warn);border-color:var(--warn);font-size:11px">ğŸ† PEAKING</span>' : ''}
          <div class="chip">${currentWeek ? `Viikko ${currentWeek}` : "PÃ¤Ã¤ttynyt"}</div>
        </div>
      </div>
    </div>

    ${meso.weekDefs.map(w => {
      const isCurrent = w.week === currentWeek;
      const isPast = currentWeek && w.week < currentWeek;
      return `<div class="card" style="${isCurrent ? 'border-color:var(--acc)' : isPast ? 'opacity:0.6' : ''}">
        <div class="flex-between">
          <div style="font-weight:600">Viikko ${w.week}: ${w.label}</div>
          ${isCurrent ? '<span class="chip" style="font-size:11px">NYT</span>' : isPast ? '<span class="dim">âœ“</span>' : ""}
        </div>
        <div class="muted mt">
          Delta: ${(w.deltaPctBase * 100).toFixed(1)}% |
          Heavy: ${w.heavyReps} toistoa, V${w.heavyTargetVx}
        </div>
        ${renderWeekPlanDays(meso, w.week, dayNames)}
      </div>`;
    }).join("")}

    ${futureWorkouts.length > 0 ? `<div class="card">
      <div class="card-title">ğŸ“… Tulevat treenit (${futureWorkouts.length} pÃ¤ivÃ¤Ã¤)</div>
      ${futureWorkouts.map(fw => `<div style="padding:10px 0;border-bottom:1px solid var(--border)">
        <div class="flex-between">
          <span style="font-weight:600">${dayNames[fw.dayOfWeek]} ${fw.dateISO.slice(5)}</span>
          <span class="chip" style="font-size:11px">${fw.dayType}</span>
        </div>
        <div style="margin-top:6px">
          ${fw.slots.map((s, i) => {
            const icon = s.role === "primary" ? "â­" : s.role === "backoff" ? "â†©" : ["warmup","opener","attempt2","attempt3"].includes(s.role) ? "ğŸ†" : `${i + 1}.`;
            const vTag = s.variantName ? ` <span style="color:var(--acc);font-size:10px">[${s.variantName.split("(")[0].trim().split(" ")[0]}]</span>` : "";
            return `<div class="flex-between" style="padding:3px 0">
            <span class="muted">${icon} ${s.defaultMovementName}${vTag}</span>
            <span class="muted">${s.sets}Ã—${s.reps}${s.targetVx !== null ? ` V${s.targetVx}` : ""}</span>
          </div>`;
          }).join("")}
        </div>
      </div>`).join("")}
    </div>` : ""}

    <button class="btn btn-outline btn-full mt" id="btn-new-meso">Aloita uusi mesosykli</button>
    ${meso.type !== "peaking" ? '<button class="btn btn-full mt" id="btn-start-peaking" style="background:var(--warn);color:#000;font-weight:700">ğŸ† Aloita Peaking-ohjelma</button>' : ''}
  </div>`;
}

function renderWeekPlanDays(meso, weekNum, dayNames) {
  const weekPlan = (meso.weekPlans || []).find(wp => wp.week === weekNum);
  if (!weekPlan || !weekPlan.days) return '';
  return `<div style="margin-top:8px">
    ${weekPlan.days.map(d => `<div style="padding:6px 0;border-top:1px solid var(--border)">
      <div class="flex-between">
        <span style="font-size:13px;font-weight:600">${dayNames[d.dayOfWeek]} â€” ${d.dayType}</span>
        <button class="btn btn-sm btn-outline" data-edit-day="${weekNum}-${d.dayOfWeek}" style="font-size:11px;padding:4px 8px;min-height:28px">âœï¸</button>
      </div>
      <div class="muted" style="font-size:12px">${d.slots.map(s => {
        const icon = s.role === "primary" ? "â­" : s.role === "backoff" ? "â†©" : ["warmup","opener","attempt2","attempt3"].includes(s.role) ? "ğŸ†" : "â€¢";
        const vTag = s.variantName ? ` [${s.variantName.split("(")[0].trim().split(" ")[0]}]` : "";
        return `${icon} ${s.defaultMovementName}${vTag} ${s.sets}Ã—${s.reps}`;
      }).join(" | ")}</div>
    </div>`).join("")}
  </div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MOVEMENTS VIEW
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function renderMovements() {
  const byCategory = {};
  state.movements.forEach(m => {
    if (!byCategory[m.category]) byCategory[m.category] = [];
    byCategory[m.category].push(m);
  });

  const categoryLabels = {
    vertikaaliveto: "Vertikaaliveto", horisontaaliveto: "Horisontaaliveto",
    hauisfleksio: "Hauisfleksio", vertikaalityÃ¶ntÃ¶: "VertikaalityÃ¶ntÃ¶",
    horisontaalityÃ¶ntÃ¶: "HorisontaalityÃ¶ntÃ¶", ojentajaekstensio: "Ojentajaekstensio",
    core: "Core", alaraaja: "Alaraaja", muu: "Muu",
  };

  const bw = state.settings?.bodyweightKg || 91;

  // Compute e1RM for every movement
  const movementE1RMs = {};
  for (const m of state.movements) {
    const sets = state.allSets.filter(s => s.movementId === m.movementId);
    movementE1RMs[m.movementId] = computeMovementE1RM(sets, m.isPrimary, bw);
  }

  return `<div class="fade-in">
    <div class="flex-between mb">
      <div class="section-header" style="margin:0">Liikepankki</div>
      <button class="btn btn-sm" id="btn-add-movement">+ LisÃ¤Ã¤</button>
    </div>

    ${Object.entries(byCategory).map(([cat, movs]) => `
      <div class="card">
        <div class="card-title">${categoryLabels[cat] || cat} ${PULL_VOLUME_CATEGORIES.has(cat) ? "âœ… vetokuorma" : ""}</div>
        ${movs.map(m => {
          const e1rm = movementE1RMs[m.movementId];
          const e1rmStr = e1rm !== null ? `${e1rm.toFixed(1)} kg` : "-";
          const stag = checkStagnation({ stagnationWeeks: 0 }); // TODO: from progress
          return `<div class="flex-between" style="padding:8px 0;border-bottom:1px solid var(--border)">
            <div style="flex:1">
              <div data-view-movement="${m.movementId}" style="cursor:pointer">${m.isPrimary ? "â­ " : ""}${m.name}</div>
              <div class="muted" style="font-size:11px">e1RM: <strong>${e1rmStr}</strong></div>
            </div>
            <div style="display:flex;gap:4px;align-items:center">
              <button class="btn btn-sm btn-outline" data-view-movement="${m.movementId}" style="font-size:11px;padding:4px 8px;min-height:28px">ğŸ“Š</button>
              ${!m.isPreset ? `<button class="btn btn-sm btn-outline" data-delete-mov="${m.movementId}" style="font-size:11px;padding:4px 8px;min-height:28px">ğŸ—‘</button>` : ""}
            </div>
          </div>`;
        }).join("")}
      </div>
    `).join("")}

    <div id="add-movement-form" class="card hidden">
      <div class="card-title">LisÃ¤Ã¤ liike</div>
      <label>Nimi</label>
      <input id="new-mov-name" placeholder="esim. Cable lateral raise">
      <label>Kategoria</label>
      <select id="new-mov-category">
        ${CATEGORIES.map(c => `<option value="${c}">${categoryLabels[c] || c}</option>`).join("")}
      </select>
      <button class="btn btn-full mt" id="btn-save-movement">Tallenna</button>
    </div>

    <div id="movement-detail" class="hidden"></div>
  </div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HISTORY VIEW
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function renderHistory() {
  const recent = [...state.sessions].reverse().slice(0, 20);

  return `<div class="fade-in">
    <div class="section-header">Historia</div>
    ${recent.length === 0 ? '<div class="card"><div class="muted">Ei treenejÃ¤ vielÃ¤</div></div>' : ""}
    ${recent.map(s => {
      const sets = state.allSets.filter(set => set.sessionId === s.sessionId);
      const dayType = s.plannedDayType || "-";
      return `<div class="card">
        <div class="flex-between">
          <div>
            <div style="font-weight:600">${formatDateShort(s.dateISO)}</div>
            <div class="muted">${dayType} | ${sets.length} sarjaa</div>
          </div>
          <button class="btn btn-sm btn-outline" data-delete-session="${s.sessionId}">ğŸ—‘</button>
        </div>
        ${sets.slice(0, 5).map(set => {
          const mov = state.movements.find(m => m.movementId === set.movementId);
          return `<div class="muted" style="padding:2px 0">${mov?.name || "?"}: ${set.externalLoadKg || 0} kg Ã— ${set.reps || 0} V${set.actualVx ?? "?"}</div>`;
        }).join("")}
        ${sets.length > 5 ? `<div class="muted">...ja ${sets.length - 5} sarjaa lisÃ¤Ã¤</div>` : ""}
      </div>`;
    }).join("")}
  </div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TRENDS VIEW (placeholder)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function renderTrends() {
  const bw = state.settings?.bodyweightKg || 91;

  // Compute e1RM for all movements that have data
  const movementTrends = [];
  for (const m of state.movements) {
    const sets = state.allSets.filter(s => s.movementId === m.movementId);
    if (sets.length === 0) continue;
    const history = computeMovementE1RMHistory(sets, state.sessions, m.isPrimary, bw);
    if (history.length === 0) continue;
    const current = history[history.length - 1].e1rm;
    const first = history[0].e1rm;
    const change = history.length > 1 ? current - first : 0;
    movementTrends.push({ movement: m, history, current, change, totalSets: sets.length });
  }

  // Sort: primary first, then by total sets descending
  movementTrends.sort((a, b) => {
    if (a.movement.isPrimary && !b.movement.isPrimary) return -1;
    if (!a.movement.isPrimary && b.movement.isPrimary) return 1;
    return b.totalSets - a.totalSets;
  });

  return `<div class="fade-in">
    <div class="section-header">Trendit</div>

    ${movementTrends.length === 0 ? '<div class="card"><div class="muted">Ei dataa â€” tee treenejÃ¤ nÃ¤hdÃ¤ksesi trendit</div></div>' : ""}

    ${movementTrends.map(mt => {
      const changeStr = mt.change > 0 ? `<span class="text-ok">+${mt.change.toFixed(1)}</span>` : mt.change < 0 ? `<span class="text-bad">${mt.change.toFixed(1)}</span>` : `<span class="dim">Â±0</span>`;
      const isPrimary = mt.movement.isPrimary;
      const label = isPrimary ? "e1RM system (kg)" : "e1RM (kg)";

      return `<div class="card">
        <div class="flex-between">
          <div>
            <div style="font-weight:600">${isPrimary ? "â­ " : ""}${mt.movement.name}</div>
            <div class="muted" style="font-size:11px">${mt.movement.category} | ${mt.totalSets} sarjaa</div>
          </div>
          <div style="text-align:right">
            <div style="font-size:20px;font-weight:700">${mt.current.toFixed(1)}</div>
            <div class="muted" style="font-size:11px">${label} ${changeStr}</div>
          </div>
        </div>
        ${mt.history.length > 1 ? renderMiniChart(mt.history) : ""}
        <div class="accordion-header" data-toggle="trend-${mt.movement.movementId}">
          <span class="muted">Historia (${mt.history.length})</span><span>â–¼</span>
        </div>
        <div class="accordion-body" id="trend-${mt.movement.movementId}">
          <table>
            <tr><th>Pvm</th><th>Paino</th><th>Toistot</th><th>e1RM</th></tr>
            ${mt.history.slice(-10).map(p => `<tr><td>${formatDateShort(p.dateISO)}</td><td>${p.load} kg</td><td>${p.reps}</td><td>${p.e1rm.toFixed(1)}</td></tr>`).join("")}
          </table>
        </div>
      </div>`;
    }).join("")}
  </div>`;
}

function renderMiniChart(history) {
  // Simple CSS bar chart
  if (history.length < 2) return "";
  const values = history.slice(-12).map(h => h.e1rm);
  const max = Math.max(...values);
  const min = Math.min(...values);
  const range = max - min || 1;
  return `<div style="display:flex;align-items:end;gap:2px;height:40px;margin:8px 0">
    ${values.map(v => {
      const pct = ((v - min) / range) * 100;
      const h = Math.max(4, pct * 0.4);
      return `<div style="flex:1;height:${h}px;background:var(--acc);border-radius:2px 2px 0 0;min-width:4px" title="${v.toFixed(1)}"></div>`;
    }).join("")}
  </div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SETTINGS VIEW
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function renderSettingsView() {
  const s = state.settings || {};
  return `<div class="fade-in">
    <div class="section-header">Asetukset</div>

    <div class="card">
      <div class="card-title">Urheilija</div>
      <label>Kehonpaino (kg)</label>
      <input type="number" inputmode="decimal" id="set-bw" value="${s.bodyweightKg || 91}">
    </div>

    <div class="card">
      <div class="card-title">Kynnysarvot</div>
      <div class="row">
        <div>
          <label>Max delta</label>
          <input type="number" inputmode="decimal" step="0.01" id="set-maxdelta" value="${s.maxDelta || 0.25}">
        </div>
        <div>
          <label>VL% raja</label>
          <input type="number" inputmode="decimal" id="set-vlstop" value="${s.vlStopPercent || 20}">
        </div>
      </div>
      <div class="row">
        <div>
          <label>Velocity ikkuna (N)</label>
          <input type="number" id="set-velwindow" value="${s.readinessVelocityWindowN || 10}">
        </div>
        <div>
          <label>HRV ikkuna (N)</label>
          <input type="number" id="set-hrvwindow" value="${s.readinessHrvWindowN || 14}">
        </div>
      </div>
    </div>

    <button class="btn btn-full mb" id="btn-save-settings">Tallenna asetukset</button>

    <div class="card">
      <div class="card-title">Data</div>
      <div class="btn-group">
        <button class="btn btn-sm btn-outline" id="btn-export-backup">ğŸ“¤ Backup JSON</button>
        <button class="btn btn-sm btn-outline" id="btn-import-backup">ğŸ“¥ Restore JSON</button>
      </div>
      <input type="file" id="file-import" accept=".json,.csv" class="hidden">
      <div class="btn-group mt">
        <button class="btn btn-sm btn-outline" id="btn-import-csv">ğŸ“„ Import CSV</button>
        <input type="file" id="file-csv" accept=".csv" class="hidden">
      </div>
    </div>

    <div class="card">
      <div class="card-title">Diagnostiikka</div>
      <div class="muted">
        Versio: 2.2.0 | Schema: 3<br>
        Sessioita: ${state.sessions.length} | Sarjoja: ${state.allSets.length}<br>
        LiikkeitÃ¤: ${state.movements.length}
      </div>
      <button class="btn btn-sm btn-outline mt" id="btn-run-tests">ğŸ§ª Aja testit</button>
    </div>

    <button class="btn btn-danger btn-full mt" id="btn-wipe">Poista kaikki data</button>
  </div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EVENT BINDING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function bind() {
  const $ = (sel) => document.querySelector(sel);
  const $$ = (sel) => document.querySelectorAll(sel);

  // Navigation
  $$("[data-nav]").forEach(btn => {
    btn.addEventListener("click", () => {
      state.view = btn.dataset.nav;
      render();
    });
  });

  // Accordion
  $$("[data-toggle]").forEach(btn => {
    btn.addEventListener("click", () => {
      const target = document.getElementById(btn.dataset.toggle);
      if (target) target.classList.toggle("open");
    });
  });

  // Dashboard
  const startBtn = $("#btn-start-workout");
  if (startBtn) startBtn.addEventListener("click", () => { state.view = "workout"; render(); });

  const readinessBtn = $("#btn-readiness");
  if (readinessBtn) readinessBtn.addEventListener("click", () => { state.view = "readiness"; render(); });

  // Readiness
  const saveReadinessBtn = $("#btn-save-readiness");
  if (saveReadinessBtn) saveReadinessBtn.addEventListener("click", async () => {
    const hrvInput = parseNumericInput($("#input-hrv")?.value);
    const velInput = parseNumericInput($("#input-vel")?.value);

    if (hrvInput !== null) {
      const hvr = validateHRV(hrvInput);
      if (!hvr.valid) { showToast(hvr.error, "bad"); return; }
      state.todayHRV = hvr.value;
      await saveMeasurement({
        dateISO: todayISO(), type: "HRV",
        value: hvr.value, valueTransformed: ouraHRVtoLnRMSSD(hvr.value),
        unit: "ms", device: "Oura",
      });
    }

    if (velInput !== null) {
      const vv = validateVelocity(velInput);
      if (!vv.valid) { showToast(vv.error, "bad"); return; }
      state.todayVelocity = vv.value;
    }

    await computeReadiness();
    await computeRecommendation();
    showToast("Readiness tallennettu", "ok");
    state.view = "dashboard";
    render();
  });

  // Workout setup
  const beginBtn = $("#btn-begin-workout");
  if (beginBtn) beginBtn.addEventListener("click", () => startWorkout());

  // Active workout
  bindWorkoutEvents();

  // Mesocycle
  const newMesoBtn = $("#btn-new-meso");
  if (newMesoBtn) newMesoBtn.addEventListener("click", async () => {
    const meso = createDefaultMesocycle(todayISO());
    // Assign variant rotation to the new mesocycle
    assignVariantRotation(meso.weekPlans);
    await saveMesocycle(meso);
    state.mesocycle = meso;
    await computeRecommendation();
    showToast("Uusi mesosykli aloitettu", "ok");
    render();
  });

  // Start peaking program
  const peakingBtn = $("#btn-start-peaking");
  if (peakingBtn) peakingBtn.addEventListener("click", async () => {
    const bw = state.settings?.bodyweightKg || 91;
    // Get current e1RM external
    const primaryMov = state.movements.find(m => m.isPrimary);
    let e1rmExt = 93;
    if (primaryMov) {
      const sets = state.allSets.filter(s => s.movementId === primaryMov.movementId);
      const computed = computeMovementE1RM(sets, true, bw);
      if (computed !== null) e1rmExt = Math.max(0, computed - bw);
    }

    const confirmMsg = `ğŸ† Peaking-ohjelma (4 viikkoa)\n\nNykyinen e1RM: +${e1rmExt.toFixed(1)} kg\n\nOpener (92%): +${roundToHalf(e1rmExt * 0.92)} kg\n2. yritys (97%): +${roundToHalf(e1rmExt * 0.97)} kg\n3. yritys (102%): +${roundToHalf(e1rmExt * 1.02)} kg\n\nAloitetaanko peaking?`;
    if (!confirm(confirmMsg)) return;

    const peakMeso = createPeakingMesocycle(todayISO(), e1rmExt, bw);
    await saveMesocycle(peakMeso);
    state.mesocycle = peakMeso;
    await computeRecommendation();
    showToast("ğŸ† Peaking-ohjelma aloitettu!", "ok", 4000);
    render();
  });

  // Edit day plan slots
  $$("[data-edit-day]").forEach(btn => {
    btn.addEventListener("click", async () => {
      const [weekStr, dayStr] = btn.dataset.editDay.split("-");
      const weekNum = parseInt(weekStr);
      const dayOfWeek = parseInt(dayStr);
      const weekPlan = state.mesocycle.weekPlans.find(wp => wp.week === weekNum);
      if (!weekPlan) return;
      const day = weekPlan.days.find(d => d.dayOfWeek === dayOfWeek);
      if (!day) return;

      const dayNames = { 1: "Ma", 2: "Ti", 3: "Ke", 4: "To", 5: "Pe", 6: "La", 7: "Su" };
      const currentSlots = day.slots.map((s, i) => `${i + 1}. ${s.defaultMovementName} ${s.sets}Ã—${s.reps}`).join("\n");

      const action = prompt(
        `${dayNames[dayOfWeek]} â€” ${day.dayType}\n\nNykyiset liikkeet:\n${currentSlots}\n\nValitse:\n1. Vaihda liike\n2. LisÃ¤Ã¤ liike\n3. Poista liike\n4. Muuta sarjoja/toistoja`,
        "1"
      );

      if (action === "1") {
        const slotIdx = parseInt(prompt("MinkÃ¤ liikkeen vaihdat? (numero):", "2")) - 1;
        if (slotIdx < 0 || slotIdx >= day.slots.length) return;
        const slot = day.slots[slotIdx];
        const sameCat = state.movements.filter(m => m.category === slot.category);
        const others = state.movements.filter(m => m.category !== slot.category);
        const options = [...sameCat, ...others];
        const choice = prompt(
          `Vaihda ${slot.defaultMovementName}:\n${options.map((m, i) => `${i + 1}. ${m.name} (${m.category})`).join("\n")}\n\nNumero:`,
          "1"
        );
        const idx = parseInt(choice) - 1;
        if (idx >= 0 && idx < options.length) {
          slot.defaultMovementName = options[idx].name;
          slot.category = options[idx].category;
          await saveMesocycle(state.mesocycle);
          await computeRecommendation();
          showToast(`Vaihdettu: ${options[idx].name}`, "ok");
          render();
        }
      } else if (action === "2") {
        const options = state.movements;
        const choice = prompt(
          `LisÃ¤Ã¤ liike:\n${options.map((m, i) => `${i + 1}. ${m.name} (${m.category})`).join("\n")}\n\nNumero:`,
          "1"
        );
        const idx = parseInt(choice) - 1;
        if (idx >= 0 && idx < options.length) {
          const m = options[idx];
          const sets = parseInt(prompt("Sarjat:", "3")) || 3;
          const reps = parseInt(prompt("Toistot:", "10")) || 10;
          day.slots.push({
            role: "accessory",
            category: m.category,
            defaultMovementName: m.name,
            sets,
            reps,
            targetVx: null,
          });
          await saveMesocycle(state.mesocycle);
          await computeRecommendation();
          showToast(`${m.name} lisÃ¤tty`, "ok");
          render();
        }
      } else if (action === "3") {
        const slotIdx = parseInt(prompt("Poista liike (numero):", "2")) - 1;
        if (slotIdx >= 0 && slotIdx < day.slots.length && day.slots[slotIdx].role !== "primary") {
          const removed = day.slots.splice(slotIdx, 1);
          await saveMesocycle(state.mesocycle);
          await computeRecommendation();
          showToast(`${removed[0].defaultMovementName} poistettu`, "ok");
          render();
        } else {
          showToast("PÃ¤Ã¤liikettÃ¤ ei voi poistaa", "warn");
        }
      } else if (action === "4") {
        const slotIdx = parseInt(prompt("Muokkaa liike (numero):", "2")) - 1;
        if (slotIdx >= 0 && slotIdx < day.slots.length) {
          const slot = day.slots[slotIdx];
          const newSets = parseInt(prompt(`${slot.defaultMovementName} sarjat:`, slot.sets)) || slot.sets;
          const newReps = parseInt(prompt(`${slot.defaultMovementName} toistot:`, slot.reps)) || slot.reps;
          slot.sets = newSets;
          slot.reps = newReps;
          await saveMesocycle(state.mesocycle);
          await computeRecommendation();
          showToast("PÃ¤ivitetty", "ok");
          render();
        }
      }
    });
  });

  // Movement detail view
  $$("[data-view-movement]").forEach(btn => {
    btn.addEventListener("click", () => {
      const movId = btn.dataset.viewMovement;
      const mov = state.movements.find(m => m.movementId === movId);
      if (!mov) return;
      showMovementDetail(mov);
    });
  });

  // Movements
  const addMovBtn = $("#btn-add-movement");
  if (addMovBtn) addMovBtn.addEventListener("click", () => {
    const form = $("#add-movement-form");
    if (form) form.classList.toggle("hidden");
  });

  const saveMovBtn = $("#btn-save-movement");
  if (saveMovBtn) saveMovBtn.addEventListener("click", async () => {
    const name = $("#new-mov-name")?.value?.trim();
    const category = $("#new-mov-category")?.value;
    if (!name) { showToast("SyÃ¶tÃ¤ liikkeen nimi", "bad"); return; }
    await addMovement(name, category);
    await refresh();
    showToast(`${name} lisÃ¤tty`, "ok");
    render();
  });

  $$("[data-delete-mov]").forEach(btn => {
    btn.addEventListener("click", async () => {
      if (!confirm("Poistetaanko liike?")) return;
      await deleteMovement(btn.dataset.deleteMov);
      await refresh();
      render();
    });
  });

  // History
  $$("[data-delete-session]").forEach(btn => {
    btn.addEventListener("click", async () => {
      if (!confirm("Poistetaanko treeni?")) return;
      await deleteSession(btn.dataset.deleteSession);
      await refresh();
      render();
    });
  });

  // Settings
  const saveSettingsBtn = $("#btn-save-settings");
  if (saveSettingsBtn) saveSettingsBtn.addEventListener("click", async () => {
    const bw = parseNumericInput($("#set-bw")?.value);
    const bwValid = validateBodyweight(bw);
    if (bw !== null && !bwValid.valid) { showToast(bwValid.error, "bad"); return; }

    state.settings.bodyweightKg = bw || 91;
    state.settings.maxDelta = parseNumericInput($("#set-maxdelta")?.value) || 0.25;
    state.settings.vlStopPercent = parseNumericInput($("#set-vlstop")?.value) || 20;
    state.settings.readinessVelocityWindowN = parseNumericInput($("#set-velwindow")?.value) || 10;
    state.settings.readinessHrvWindowN = parseNumericInput($("#set-hrvwindow")?.value) || 14;
    await saveSettings(state.settings);
    await computeRecommendation();
    showToast("Asetukset tallennettu", "ok");
    render();
  });

  // Backup
  const exportBtn = $("#btn-export-backup");
  if (exportBtn) exportBtn.addEventListener("click", async () => {
    const data = await exportFullBackup();
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = `leve-coach-backup-${todayISO()}.json`;
    document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    showToast("Backup ladattu", "ok");
  });

  const importBtn = $("#btn-import-backup");
  if (importBtn) importBtn.addEventListener("click", () => $("#file-import")?.click());

  const fileInput = $("#file-import");
  if (fileInput) fileInput.addEventListener("change", async (e) => {
    const file = e.target.files[0];
    if (!file) return;
    try {
      const text = await file.text();
      const data = JSON.parse(text);
      await importFullBackup(data);
      await refresh();
      showToast("Restore valmis", "ok");
      render();
    } catch (err) {
      showToast("Import epÃ¤onnistui: " + err.message, "bad");
    }
  });

  // CSV import
  const csvBtn = $("#btn-import-csv");
  if (csvBtn) csvBtn.addEventListener("click", () => $("#file-csv")?.click());

  const csvInput = $("#file-csv");
  if (csvInput) csvInput.addEventListener("change", async (e) => {
    const file = e.target.files[0];
    if (!file) return;
    try {
      const text = await file.text();
      // Simple auto-mapping: expects columns: date, movement, weight, reps, sets, vara
      const result = await importHistoricalCSV(text, {
        date: 0, movement: 1, weight: 2, reps: 3, sets: 4, vara: 5,
      });
      await refresh();
      showToast(`Import: ${result.sessionsImported} sessiota, ${result.setsImported} sarjaa`, "ok");
      render();
    } catch (err) {
      showToast("CSV import epÃ¤onnistui: " + err.message, "bad");
    }
  });

  // Wipe
  const wipeBtn = $("#btn-wipe");
  if (wipeBtn) wipeBtn.addEventListener("click", async () => {
    if (!confirm("Poistetaanko kaikki data pysyvÃ¤sti?")) return;
    if (!confirm("Oletko varma? TÃ¤tÃ¤ ei voi perua.")) return;
    await importFullBackup({}); // Clears everything
    await refresh();
    showToast("Data poistettu", "ok");
    render();
  });

  // Tests
  const testBtn = $("#btn-run-tests");
  if (testBtn) testBtn.addEventListener("click", () => {
    const url = new URL(window.location.href);
    url.searchParams.set("test", "1");
    window.location.href = url.toString();
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// WORKOUT ENGINE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function startWorkout() {
  const rec = state.recommendation;
  const bw = state.settings?.bodyweightKg || 91;
  const exercises = [];

  // Build exercises from day plan
  if (rec?.dayPlan?.slots) {
    for (const slot of rec.dayPlan.slots) {
      const mov = state.movements.find(m => m.name === slot.defaultMovementName);
      const movId = mov?.movementId || null;
      const isPrimary = slot.role === "primary";
      const isAttempt = ["warmup", "opener", "attempt2", "attempt3"].includes(slot.role);

      let loadKg;
      const isBackoff = slot.role === "backoff";

      // Competition day: use computed attempt loads
      if (isAttempt && rec.attemptLoads) {
        if (slot.role === "warmup" && Array.isArray(slot.loadPctE1RM)) {
          // Warmup sets use slot-level percentages (handled per-set below)
          loadKg = rec.attemptLoads.warmupLoads[0] || 0;
        } else if (slot.role === "opener") {
          loadKg = rec.attemptLoads.opener;
        } else if (slot.role === "attempt2") {
          loadKg = rec.attemptLoads.second;
        } else if (slot.role === "attempt3") {
          loadKg = rec.attemptLoads.third;
        }
      } else if (isPrimary && rec.targetExternalLoad !== null) {
        // Apply variant load modifier
        const vMod = variantLoadModifier(slot.variantName);
        loadKg = roundToHalf(rec.targetExternalLoad * (1 + vMod));
      } else if (isBackoff && rec.targetExternalLoad !== null) {
        const vMod = variantLoadModifier(slot.variantName);
        loadKg = roundToHalf(rec.targetExternalLoad * 0.85 * (1 + vMod));
      } else if (mov) {
        // Get movement progress for accessory
        const progress = await getMovementProgress(movId);
        if (progress?.suggestedLoadKg) {
          loadKg = progress.suggestedLoadKg;
        } else if (progress?.lastLoadKg) {
          loadKg = progress.lastLoadKg;
        } else {
          loadKg = null; // New movement â€” user will enter
        }
      } else {
        loadKg = null;
      }

      const progressInfo = mov ? await getMovementProgress(movId) : null;
      const progressSuggestion = progressInfo?.suggestedAction || "hold";

      // Variant tempo override
      const vOverride = variantRepOverride(slot.variantName);

      // Build per-set loads (warmup sets have different loads)
      const setsList = Array.from({ length: slot.sets }, (_, i) => {
        let setLoad = loadKg;
        if (isAttempt && slot.role === "warmup" && rec.attemptLoads) {
          setLoad = rec.attemptLoads.warmupLoads[i] || loadKg;
        }
        return {
          idx: i,
          targetReps: slot.reps,
          targetVx: slot.targetVx,
          loadKg: setLoad,
          reps: null,
          actualVx: null,
          velocity: null,
          completed: false,
        };
      });

      exercises.push({
        movementId: movId,
        name: slot.defaultMovementName || slot.category,
        category: slot.category,
        originalCategory: slot.category,
        role: slot.role,
        variantName: slot.variantName || null,
        tempoNote: vOverride?.tempoNote || null,
        loadKg,
        progressSuggestion,
        sets: setsList,
      });
    }
  } else {
    // Fallback: just primary movement
    exercises.push({
      movementId: null,
      name: "LisÃ¤painoleuanveto",
      category: "vertikaaliveto",
      originalCategory: "vertikaaliveto",
      role: "primary",
      loadKg: rec?.targetExternalLoad,
      progressSuggestion: "hold",
      sets: Array.from({ length: rec?.setCount || 3 }, (_, i) => ({
        idx: i,
        targetReps: rec?.targetReps || 3,
        targetVx: rec?.targetVx || 2,
        loadKg: rec?.targetExternalLoad,
        reps: null,
        actualVx: null,
        velocity: null,
        completed: false,
      })),
    });
  }

  state.workout = {
    sessionId: uid(),
    dayType: rec?.dayType || "heavy",
    exercises,
    currentExerciseIdx: 0,
    currentSetIdx: 0,
    startedAt: new Date().toISOString(),
  };

  render();
}

function bindWorkoutEvents() {
  const $ = (sel) => document.querySelector(sel);
  const $$ = (sel) => document.querySelectorAll(sel);
  const w = state.workout;
  if (!w) return;

  let selectedReps = null;
  let selectedVara = null;

  // Reps buttons
  $$("[data-reps]").forEach(btn => {
    btn.addEventListener("click", () => {
      $$("[data-reps]").forEach(b => b.classList.remove("selected"));
      btn.classList.add("selected");
      selectedReps = parseInt(btn.dataset.reps);
      checkNextSetEnabled();
    });
  });

  // Vara buttons
  $$("[data-vara]").forEach(btn => {
    btn.addEventListener("click", () => {
      $$("[data-vara]").forEach(b => b.classList.remove("selected"));
      btn.classList.add("selected");
      selectedVara = parseInt(btn.dataset.vara);
      checkNextSetEnabled();
    });
  });

  function checkNextSetEnabled() {
    const nextBtn = $("#btn-next-set");
    if (nextBtn) nextBtn.disabled = !(selectedReps !== null && selectedVara !== null);
  }

  // Edit load
  const loadBtn = $("#btn-edit-load");
  if (loadBtn) loadBtn.addEventListener("click", () => {
    const exercise = w.exercises[w.currentExerciseIdx];
    const currentSet = exercise?.sets[w.currentSetIdx];
    if (!currentSet) return;
    const input = prompt("SyÃ¶tÃ¤ paino (kg):", currentSet.loadKg || "");
    if (input !== null) {
      const v = parseNumericInput(input);
      if (v !== null) {
        currentSet.loadKg = v;
        // Update all remaining sets too
        exercise.sets.forEach((s, i) => { if (i >= w.currentSetIdx) s.loadKg = v; });
        render();
      }
    }
  });

  // Next set
  const nextSetBtn = $("#btn-next-set");
  if (nextSetBtn) nextSetBtn.addEventListener("click", () => {
    const exercise = w.exercises[w.currentExerciseIdx];
    const currentSet = exercise?.sets[w.currentSetIdx];
    if (!currentSet) return;

    const velocity = parseNumericInput($("#input-set-velocity")?.value);

    currentSet.reps = selectedReps;
    currentSet.actualVx = selectedVara;
    currentSet.velocity = velocity;
    currentSet.completed = true;

    // Failure reaction
    if (selectedVara === 0) {
      const isPrimary = exercise.role === "primary";
      const consecutiveFailures = exercise.sets.slice(0, w.currentSetIdx + 1).filter(s => s.actualVx === 0).length;
      const reaction = failureReaction(currentSet.loadKg || 0, currentSet.targetReps, isPrimary, consecutiveFailures);

      if (reaction.shouldStop) {
        showToast("2Ã— failure â€” lopetatko tÃ¤hÃ¤n liikkeeseen?", "bad", 5000);
      } else {
        showToast(reaction.message, "warn");
      }

      // Adjust remaining sets
      exercise.sets.forEach((s, i) => {
        if (i > w.currentSetIdx && !s.completed) {
          s.loadKg = reaction.nextSetLoad;
          s.targetReps = reaction.nextSetReps;
        }
      });
    }

    // VL% calculation
    if (velocity && exercise.sets[0]?.velocity) {
      const vl = velocityLossPercent(exercise.sets[0].velocity, velocity);
      if (vl !== null && vl > (state.settings?.vlStopPercent || 20)) {
        showToast(`VL% = ${vl.toFixed(1)}% â€” yli rajan!`, "warn");
      }
    }

    // Start rest timer
    startRestTimer();

    w.currentSetIdx++;
    selectedReps = null;
    selectedVara = null;
    render();
  });

  // Add extra set to current exercise
  const addSetBtn = $("#btn-add-set");
  if (addSetBtn) addSetBtn.addEventListener("click", () => {
    const exercise = w.exercises[w.currentExerciseIdx];
    if (!exercise) return;
    const lastSet = exercise.sets[exercise.sets.length - 1];
    exercise.sets.push({
      idx: exercise.sets.length,
      targetReps: lastSet?.targetReps || 3,
      targetVx: lastSet?.targetVx || 2,
      loadKg: lastSet?.loadKg || null,
      reps: null,
      actualVx: null,
      velocity: null,
      completed: false,
    });
    showToast("LisÃ¤sarja lisÃ¤tty", "ok");
    render();
  });

  // Add extra exercise
  const addExBtn = $("#btn-add-exercise");
  if (addExBtn) addExBtn.addEventListener("click", () => {
    const options = state.movements.filter(m => !w.exercises.some(ex => ex.movementId === m.movementId));
    if (options.length === 0) { showToast("Kaikki liikkeet jo mukana", "warn"); return; }
    const choice = prompt(
      `LisÃ¤Ã¤ liike:\n${options.map((m, i) => `${i + 1}. ${m.name} (${m.category})`).join("\n")}\n\nSyÃ¶tÃ¤ numero:`,
      "1"
    );
    const idx = parseInt(choice) - 1;
    if (idx >= 0 && idx < options.length) {
      const m = options[idx];
      const setsCount = parseInt(prompt("Sarjojen mÃ¤Ã¤rÃ¤:", "3")) || 3;
      const repsTarget = parseInt(prompt("Tavoitetoistot:", "10")) || 10;
      w.exercises.push({
        movementId: m.movementId,
        name: m.name,
        category: m.category,
        originalCategory: m.category,
        role: "accessory",
        loadKg: null,
        progressSuggestion: "hold",
        sets: Array.from({ length: setsCount }, (_, i) => ({
          idx: i,
          targetReps: repsTarget,
          targetVx: null,
          loadKg: null,
          reps: null,
          actualVx: null,
          velocity: null,
          completed: false,
        })),
      });
      showToast(`${m.name} lisÃ¤tty`, "ok");
      render();
    }
  });

  // Swap variant
  const swapVarBtn = $("#btn-swap-variant");
  if (swapVarBtn) swapVarBtn.addEventListener("click", () => {
    const exercise = w.exercises[w.currentExerciseIdx];
    if (!exercise) return;
    const allVariantNames = ["Kilpaveto (leveÃ¤ myÃ¶tÃ¤ote)", "Korokeveto", "Nopeusveto kuminauhalla", "MyÃ¶tÃ¤oteveto", "Neutraaliote", "2s ylipito", "1.5-toisto hiissaus"];
    const choice = prompt(
      `Vaihda variaatio:\n${allVariantNames.map((v, i) => `${i + 1}. ${v}${v === exercise.variantName ? " âœ“" : ""}`).join("\n")}\n\nSyÃ¶tÃ¤ numero:`,
      "1"
    );
    const idx = parseInt(choice) - 1;
    if (idx >= 0 && idx < allVariantNames.length) {
      const newVariant = allVariantNames[idx];
      exercise.variantName = newVariant;
      const vOverride = variantRepOverride(newVariant);
      exercise.tempoNote = vOverride?.tempoNote || null;
      // Recalculate remaining set loads with new variant modifier
      const vMod = variantLoadModifier(newVariant);
      const rec = state.recommendation;
      if (rec?.targetExternalLoad !== null && (exercise.role === "primary" || exercise.role === "backoff")) {
        const basePct = exercise.role === "backoff" ? 0.85 : 1.0;
        const newLoad = roundToHalf(rec.targetExternalLoad * basePct * (1 + vMod));
        exercise.sets.forEach(s => { if (!s.completed) s.loadKg = newLoad; });
        exercise.loadKg = newLoad;
      }
      showToast(`Variaatio: ${newVariant}`, "ok");
      render();
    }
  });

  // Skip exercise
  const skipBtn = $("#btn-skip-exercise");
  if (skipBtn) skipBtn.addEventListener("click", () => {
    w.currentExerciseIdx++;
    w.currentSetIdx = 0;
    stopRestTimer();
    render();
  });

  // Next exercise
  const nextExBtn = $("#btn-next-exercise");
  if (nextExBtn) nextExBtn.addEventListener("click", () => {
    w.currentExerciseIdx++;
    w.currentSetIdx = 0;
    stopRestTimer();
    render();
  });

  // Save workout
  const saveBtn = $("#btn-save-workout");
  if (saveBtn) saveBtn.addEventListener("click", async () => {
    await saveWorkoutToDb();
    showToast("Treeni tallennettu!", "ok");
    state.workout = null;
    await refresh();
    state.view = "dashboard";
    render();
  });

  // Discard workout
  const discardBtn = $("#btn-discard-workout");
  if (discardBtn) discardBtn.addEventListener("click", () => {
    if (!confirm("HylÃ¤tÃ¤Ã¤nkÃ¶ treeni?")) return;
    state.workout = null;
    state.view = "dashboard";
    render();
  });

  // End workout early
  const endBtn = $("#btn-end-workout");
  if (endBtn) endBtn.addEventListener("click", () => {
    // Jump to summary
    w.currentExerciseIdx = w.exercises.length;
    render();
  });

  // Swap exercise
  const swapBtn = $("#btn-swap-exercise");
  if (swapBtn) swapBtn.addEventListener("click", () => {
    const exercise = w.exercises[w.currentExerciseIdx];
    if (!exercise) return;
    // Show same category movements first
    const sameCategory = state.movements.filter(m => m.category === exercise.category && m.name !== exercise.name);
    const others = state.movements.filter(m => m.category !== exercise.category && m.name !== exercise.name);
    const options = [...sameCategory, ...others];
    const choice = prompt(
      `Vaihda liike:\n${options.map((m, i) => `${i + 1}. ${m.name} (${m.category})`).join("\n")}\n\nSyÃ¶tÃ¤ numero:`,
      "1"
    );
    const idx = parseInt(choice) - 1;
    if (idx >= 0 && idx < options.length) {
      exercise.name = options[idx].name;
      exercise.movementId = options[idx].movementId;
      exercise.category = options[idx].category;
      render();
    }
  });
}

async function saveWorkoutToDb() {
  const w = state.workout;
  if (!w) return;

  const bw = state.settings?.bodyweightKg || 91;
  const rec = state.recommendation;

  // Save session
  const session = {
    sessionId: w.sessionId,
    dateISO: todayISO(),
    plannedDayType: w.dayType,
    mesocycleWeek: rec?.weekNum || null,
    mesocycleId: state.mesocycle?.mesocycleId || null,
    bodyweightKg: bw,
    notes: "",
    readinessCapLevel: state.readiness.capLevel,
    readinessDetails: state.readiness,
  };
  await saveSession(session);

  // Resolve variant IDs
  const variantCache = {};
  for (const exercise of w.exercises) {
    if (exercise.variantName && !variantCache[exercise.variantName]) {
      const v = await getVariantByName(exercise.variantName);
      variantCache[exercise.variantName] = v?.variantId || null;
    }
  }

  // Save sets
  const sets = [];
  for (const exercise of w.exercises) {
    for (const s of exercise.sets) {
      if (!s.completed) continue;
      sets.push({
        setId: uid(),
        sessionId: w.sessionId,
        movementId: exercise.movementId,
        variantId: variantCache[exercise.variantName] || null,
        setRole: exercise.role === "primary" ? "top" : exercise.role === "backoff" ? "backoff" : "accessory",
        externalLoadKg: s.loadKg,
        reps: s.reps,
        targetReps: s.targetReps,
        targetVx: s.targetVx,
        actualVx: s.actualVx,
        velocityMean: s.velocity,
        velocityPeak: null,
        velocityRep1: null,
        velocityLossPercent: null,
        tempo: null,
        restSec: null,
        deviceMeta: null,
        manualOverride: null,
        timestamp: new Date().toISOString(),
      });
    }

    // Update movement progress for accessories
    if (exercise.role !== "primary" && exercise.movementId) {
      const completedSets = exercise.sets.filter(s => s.completed).map(s => ({
        movementId: exercise.movementId,
        externalLoadKg: s.loadKg,
        reps: s.reps,
        targetReps: s.targetReps,
        actualVx: s.actualVx,
        targetVx: s.targetVx,
      }));
      if (completedSets.length > 0) {
        const existing = await getMovementProgress(exercise.movementId);
        const updated = updateMovementProgressFromSets(existing, completedSets, exercise.sets[0]?.targetReps, exercise.sets[0]?.targetVx);
        updated.movementId = exercise.movementId;
        await saveMovementProgress(updated);
      }
    }
  }

  await saveSets(sets);

  // PR detection: check if any movement hit a new e1RM record
  for (const exercise of w.exercises) {
    if (!exercise.movementId) continue;
    const completedSets = exercise.sets.filter(s => s.completed);
    if (completedSets.length === 0) continue;
    const isPrimary = exercise.role === "primary";
    const exSets = state.allSets.filter(s => s.movementId === exercise.movementId);
    const prevHistory = computeMovementE1RMHistory(exSets, state.sessions, isPrimary, bw);
    const prevBest = prevHistory.length > 0 ? Math.max(...prevHistory.map(h => h.e1rm)) : 0;
    // Compute current session e1RM
    const nowSets = completedSets.map(s => ({
      externalLoadKg: s.loadKg || 0, reps: s.reps || 1,
      actualVx: s.actualVx, targetVx: s.targetVx,
    }));
    const nowE1RMs = nowSets.map(s => isPrimary
      ? e1rmSystem(bw, s.externalLoadKg, s.reps, s.actualVx ?? 2)
      : e1rmAccessory(s.externalLoadKg, s.reps)
    ).filter(v => v !== null);
    const nowBest = nowE1RMs.length > 0 ? Math.max(...nowE1RMs) : 0;
    if (nowBest > prevBest && prevBest > 0) {
      const delta = (nowBest - prevBest).toFixed(1);
      const label = isPrimary ? "system" : "";
      showToast(`ğŸ‰ PR! ${exercise.name}: ${nowBest.toFixed(1)} kg ${label} (+${delta})`, "ok", 5000);
    }
  }

  // Adaptive analysis: compare what was done vs what was planned
  if (rec?.dayPlan?.slots) {
    const adaptations = analyzeSessionAdaptation(w.exercises, rec.dayPlan.slots);
    if (adaptations.length > 0) {
      state.adaptationHistory.push(...adaptations);
      // Try to apply if enough history
      const result = applyAdaptations(state.mesocycle, state.adaptationHistory);
      if (result.applied) {
        await saveMesocycle(state.mesocycle);
        showToast(`Ohjelma optimoitu: ${result.changes[0]}`, "ok", 4000);
      }
    }
  }

  // Also update primary movement progress
  const primaryEx = w.exercises.find(ex => ex.role === "primary" && ex.movementId);
  if (primaryEx) {
    const completedSets = primaryEx.sets.filter(s => s.completed).map(s => ({
      movementId: primaryEx.movementId,
      externalLoadKg: s.loadKg,
      reps: s.reps,
      targetReps: s.targetReps,
      actualVx: s.actualVx,
      targetVx: s.targetVx,
    }));
    if (completedSets.length > 0) {
      const existing = await getMovementProgress(primaryEx.movementId);
      const updated = updateMovementProgressFromSets(existing, completedSets, primaryEx.sets[0]?.targetReps, primaryEx.sets[0]?.targetVx);
      updated.movementId = primaryEx.movementId;
      await saveMovementProgress(updated);
    }
  }

  stopRestTimer();
}

function showMovementDetail(mov) {
  const bw = state.settings?.bodyweightKg || 91;
  const sets = state.allSets.filter(s => s.movementId === mov.movementId);
  const history = computeMovementE1RMHistory(sets, state.sessions, mov.isPrimary, bw);
  const currentE1RM = history.length > 0 ? history[history.length - 1].e1rm : null;
  const totalSets = sets.length;
  const totalSessions = new Set(sets.map(s => s.sessionId)).size;

  const detailDiv = document.getElementById("movement-detail");
  if (!detailDiv) return;

  detailDiv.classList.remove("hidden");
  detailDiv.innerHTML = `<div class="card" style="border-color:var(--acc)">
    <div class="flex-between">
      <div>
        <div style="font-size:18px;font-weight:700">${mov.isPrimary ? "â­ " : ""}${mov.name}</div>
        <div class="muted">${mov.category}</div>
      </div>
      <button class="btn btn-sm btn-outline" id="btn-close-detail">âœ•</button>
    </div>
    <div class="kpi-row mt">
      <div class="kpi-box"><div class="kpi">${currentE1RM !== null ? currentE1RM.toFixed(1) : "-"}</div><div class="kpi-label">e1RM (kg)</div></div>
      <div class="kpi-box"><div class="kpi">${totalSets}</div><div class="kpi-label">Sarjoja yhteensÃ¤</div></div>
      <div class="kpi-box"><div class="kpi">${totalSessions}</div><div class="kpi-label">TreenejÃ¤</div></div>
    </div>
    ${history.length > 1 ? renderMiniChart(history) : ""}
    ${history.length > 0 ? `<table class="mt">
      <tr><th>Pvm</th><th>Paino</th><th>Toistot</th><th>e1RM</th></tr>
      ${history.slice(-8).map(p => `<tr><td>${formatDateShort(p.dateISO)}</td><td>${p.load} kg</td><td>${p.reps}</td><td>${p.e1rm.toFixed(1)}</td></tr>`).join("")}
    </table>` : '<div class="muted mt">Ei dataa vielÃ¤</div>'}
  </div>`;

  document.getElementById("btn-close-detail")?.addEventListener("click", () => {
    detailDiv.classList.add("hidden");
    detailDiv.innerHTML = "";
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// URL PARAMS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function checkUrlParams() {
  const params = new URLSearchParams(window.location.search);
  if (params.get("test") === "1") {
    import("./test-runner.js").then(mod => mod.runTests()).catch(() => {
      showToast("Test runner ei lÃ¶ytynyt", "bad");
    });
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PWA SERVICE WORKER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("sw.js").catch(() => {});
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BOOT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

init().then(() => checkUrlParams());

</script>
</body>
</html>
