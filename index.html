<!doctype html>
<html lang="fi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="theme-color" content="#0f172a" />
  <title>Lisäpainoleuanveto</title>
  <link rel="manifest" href="manifest.webmanifest" />
  <style>
    :root{--bg:#0f172a;--card:#111c33;--muted:#94a3b8;--txt:#e2e8f0;--acc:#3b82f6;--ok:#22c55e;--warn:#f59e0b;--bad:#ef4444}
    *{box-sizing:border-box} body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;background:var(--bg);color:var(--txt)}
    .wrap{max-width:1180px;margin:auto;padding:12px} .top{display:flex;justify-content:space-between;gap:8px;align-items:center;flex-wrap:wrap}
    .badge{font-size:12px;color:var(--muted)} .tabs{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0}
    button,input,select,textarea{font:inherit;border-radius:10px;border:1px solid #334155;background:#0b1224;color:var(--txt);padding:10px}
    button{cursor:pointer} .tabs button.active,.primary{background:var(--acc);border-color:var(--acc)}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:10px}
    .card{background:var(--card);padding:12px;border-radius:12px;border:1px solid #24324f}
    label{display:block;margin:6px 0;font-size:13px} input,select,textarea{width:100%;margin-top:3px}
    .row{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:8px}.row3{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:8px}
    .muted{color:var(--muted);font-size:12px}.ok{color:var(--ok)}.warn{color:var(--warn)}.bad{color:var(--bad)}
    table{width:100%;border-collapse:collapse;font-size:12px}th,td{padding:6px;border-bottom:1px solid #23314c;text-align:left}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px}
    .g{background:#14532d}.y{background:#78350f}.r{background:#7f1d1d}
    details{margin-top:8px} pre{white-space:pre-wrap;background:#0a1020;padding:8px;border-radius:8px;border:1px solid #22314d;max-height:250px;overflow:auto}
    .big{font-size:22px;font-weight:700}
  </style>
</head>
<body>
<div class="wrap">
  <div class="top">
    <h1>LisÃ¤painoleuanveto â€“ </h1>
    <div class="badge" id="versionBanner"></div>
  </div>
  <div class="tabs" id="tabs"></div>
  <section id="view"></section>
</div>
<script>
(()=>{
'use strict';
// (1) constants
const APP_VERSION='1.0.0', SCHEMA_VERSION=3, TIMEZONE='Europe/Helsinki';
const STORE_NAMES=['movements','variants','sessions','sets','repMetrics','measurements','protocols','baselines','recommendations','decisionTraces','planner'];
const LS_BOOT='coach_boot_meta';
const DAY_TYPES=['heavy','volume','speed','accessory','rest'];
const READY_CFG_DEFAULT={green:-0.5,yellow:-1.0,red:-1.0};

const state={tab:'Dashboard',db:null,data:{},settings:{hrvMode:'lnRMSSD',hrvWindow:14,maxDelta:0.05,readyCfg:READY_CFG_DEFAULT,redFallbackDay:'technique',repoBase:'.',pullupVariantId:'v_pullup_weighted'},mappingDraft:null};
const tabs=['Dashboard','Session','Planner','Tuonti/Vienti','Calibration','Diagnostics','Asetukset'];

// (2) utils/math
const uid=()=>crypto?.randomUUID?crypto.randomUUID():`id-${Date.now()}-${Math.random().toString(16).slice(2)}`;
const num=v=>{if(v===null||v===undefined||v==='')return null; const n=Number(String(v).replace(',','.').replace(/[^0-9.+-]/g,'')); return Number.isFinite(n)?n:null;};
const helsinkiISO=(d=new Date())=>new Intl.DateTimeFormat('en-CA',{timeZone:TIMEZONE,year:'numeric',month:'2-digit',day:'2-digit'}).format(d);
const sum=a=>a.reduce((x,y)=>x+(+y||0),0),avg=a=>a.length?sum(a)/a.length:0;
const median=a=>{if(!a.length)return null;const s=[...a].sort((x,y)=>x-y);const m=Math.floor(s.length/2);return s.length%2?s[m]:(s[m-1]+s[m])/2;};
const madSigma=a=>{const m=median(a); if(m===null)return null; const md=median(a.map(x=>Math.abs(x-m))); return (md===0?1e-6:1.4826*md);};
const clamp=(v,min,max)=>Math.max(min,Math.min(max,v));
const esc=s=>String(s??'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));

// (3) schema/migrations
function defaultData(){
  const movementPull={movementId:'m_pullup',name:'LisÃ¤painoleuanveto',category:'primary',tags:['pull']};
  const movementRow={movementId:'m_row',name:'Kulmasoutu',category:'accessory',tags:['pull']};
  const variantPull={variantId:'v_pullup_weighted',movementId:'m_pullup',name:'Pronated standard',grip:'pronated',romStandard:'chin_over_bar'};
  const protocolReady={protocolId:'p_ready_pullup',variantId:'v_pullup_weighted',type:'READINESS_VELOCITY',loadDef:{mode:'PCT_E1RM_EXTERNAL',value:0.6},reps:1,metric:'velocityMean',targetRIR:3,useInRecommendations:true};
  return {movements:[movementPull,movementRow],variants:[variantPull],sessions:[],sets:[],repMetrics:[],measurements:[],protocols:[protocolReady],baselines:[],recommendations:[],decisionTraces:[],planner:[]};
}

function migrateBackupJson(input){
  const out={appVersion:APP_VERSION,schemaVersion:SCHEMA_VERSION,data:defaultData()};
  const src=input?.data?input.data:input;
  if(!src) return out;
  const add=(k,val)=>{ if(Array.isArray(val)) out.data[k]=val; };
  STORE_NAMES.forEach(k=>add(k,src[k]));

  out.data.sessions=(out.data.sessions||[]).map(s=>({sessionId:s.sessionId||s.id||uid(),dateISO:s.dateISO||s.date||helsinkiISO(),plannedDayType:s.plannedDayType||'volume',notes:s.notes||'',bodyweightKg:num(s.bodyweightKg),schemaVersion:SCHEMA_VERSION}));
  out.data.sets=(out.data.sets||[]).flatMap(set=>{
    if(set && typeof set==='object'){
      const sessionId=set.sessionId||set.sid||null; if(!sessionId) return [];
      const variantId=set.variantId||state.settings.pullupVariantId;
      return [{setId:set.setId||set.id||uid(),sessionId,variantId,setRole:set.setRole||'top',externalLoadKg:Math.max(0,num(set.externalLoadKg??set.weightKg)??0),reps:Math.max(1,Math.min(30,Math.trunc(num(set.reps)??1))),rir:num(set.rir),velocityMean:num(set.velocityMean),velocityPeak:num(set.velocityPeak),tempo:set.tempo||'',restSec:Math.trunc(num(set.restSec)??0)||null,deviceMeta:{deviceType:set.deviceMeta?.deviceType||'manual',deviceName:set.deviceMeta?.deviceName||'',liftPhase:set.deviceMeta?.liftPhase||'concentric_only',velocitySource:set.deviceMeta?.velocitySource||'measured',rangeOfMotionCm:num(set.deviceMeta?.rangeOfMotionCm)},manualOverride:set.manualOverride||null,testProtocolId:set.testProtocolId||null,qualityFlags:Array.isArray(set.qualityFlags)?set.qualityFlags:[]}];
    }
    return [];
  });

  // legacy v1/v2 fallback from previous app shape
  if((out.data.sets||[]).length===0 && Array.isArray(src.sessions)){
    const extraSets=[];
    out.data.sessions=src.sessions.map(s=>{
      const sessionId=s.sessionId||s.id||uid();
      const count=Math.max(0,Math.trunc(num(s.sets)??0));
      for(let i=0;i<count;i++) extraSets.push({setId:uid(),sessionId,variantId:'v_pullup_weighted',setRole:i===0?'top':'backoff',externalLoadKg:Math.max(0,num(s.weight)??0),reps:Math.max(1,Math.min(30,Math.trunc(num(s.reps)??1))),rir:num(s.actualRIR??s.targetRIR),velocityMean:null,velocityPeak:null,deviceMeta:{deviceType:'manual',liftPhase:'concentric_only',velocitySource:'measured'},qualityFlags:[]});
      return {sessionId,dateISO:s.date||s.dateISO||helsinkiISO(),plannedDayType:'volume',notes:s.notes||'',bodyweightKg:num(s.bodyweightKg),schemaVersion:SCHEMA_VERSION};
    });
    out.data.sets=extraSets;
  }
  out.schemaVersion=SCHEMA_VERSION;
  return out;
}

// (4) indexedDB
function openDB(){return new Promise((resolve,reject)=>{const req=indexedDB.open('golden_pullup_db',3); req.onupgradeneeded=(e)=>{const db=e.target.result; STORE_NAMES.forEach(n=>{if(!db.objectStoreNames.contains(n)){const key=n==='planner'?'planId':(n.slice(0,-1)+'Id'); db.createObjectStore(n,{keyPath:key});}})}; req.onsuccess=()=>resolve(req.result); req.onerror=()=>reject(req.error);});}
function tx(store,mode='readonly'){return state.db.transaction(store,mode).objectStore(store)}
function all(store){return new Promise(res=>{const r=tx(store).getAll(); r.onsuccess=()=>res(r.result||[]); r.onerror=()=>res([]);});}
function put(store,obj){return new Promise(res=>{const r=tx(store,'readwrite').put(obj); r.onsuccess=()=>res(true); r.onerror=()=>res(false);});}
function clearStore(store){return new Promise(res=>{const r=tx(store,'readwrite').clear(); r.onsuccess=()=>res(true); r.onerror=()=>res(false);});}
async function loadAll(){for(const s of STORE_NAMES) state.data[s]=await all(s);}
async function saveAll(){for(const s of STORE_NAMES) for(const rec of state.data[s]) await put(s,rec);}

// (5) domain calculations
function getVariant(variantId){return state.data.variants.find(v=>v.variantId===variantId)}
function sessionById(id){return state.data.sessions.find(s=>s.sessionId===id)}
function systemLoad(set){const bw=sessionById(set.sessionId)?.bodyweightKg??0; return (bw||0)+(set.externalLoadKg||0)}
function e1RMSystem(set){return systemLoad(set)*(1+(set.reps||1)/30)}
function e1RMExternal(set){const bw=sessionById(set.sessionId)?.bodyweightKg??0; return Math.max(0,e1RMSystem(set)-bw)}
function trainingSetFilter(set){return ['top','backoff','volume','speed','technique'].includes(set.setRole)}

function protocolReadinessValues(protocolId){
  const p=state.data.protocols.find(x=>x.protocolId===protocolId); if(!p) return [];
  const sets=state.data.sets.filter(s=>s.setRole==='readiness_test' && (s.testProtocolId===protocolId || s.variantId===p.variantId));
  const metric=p.metric==='velocityPeak'?'velocityPeak':'velocityMean';
  return sets.map(s=>num(s[metric])).filter(v=>v!==null);
}
function baselineForProtocol(protocolId,windowN=14){
  const vals=protocolReadinessValues(protocolId).slice(-windowN);
  const med=median(vals), mad=madSigma(vals);
  const flags=[]; if(mad===1e-6) flags.push('MAD_ZERO_EPS');
  return {median:med??0,madSigma:mad??1e-6,n:vals.length,flags};
}
function zClass(z,cfg=state.settings.readyCfg){if(z>=cfg.green)return 'GREEN'; if(z>=cfg.yellow) return 'YELLOW'; return 'RED';}
function capLevelFromClass(c){return c==='RED'?2:c==='YELLOW'?1:0;}

function hrvReadiness(){
  const vals=state.data.measurements.filter(m=>m.type==='HRV').sort((a,b)=>a.dateISO.localeCompare(b.dateISO));
  const windowN=state.settings.hrvWindow||14; const recent=vals.slice(-windowN).map(v=>num(v.value)).filter(v=>v!==null);
  if(!recent.length) return {z:0,cls:'GREEN',why:'Ei HRV-dataa'};
  const med=median(recent), mad=madSigma(recent); const today=recent.at(-1); const z=(today-med)/(mad||1e-6);
  return {z,cls:zClass(z),why:`HRV z=${z.toFixed(2)}`};
}
function rirReadiness(variantId){
  const sets=state.data.sets.filter(s=>s.variantId===variantId&&s.setRole==='top').slice(-5);
  if(!sets.length) return {z:0,cls:'GREEN',why:'Ei RIR-dataa'};
  const over=sets.map(s=>(num(s.targetRIR??2)-num(s.rir??2))).at(-1);
  const cls=over>=2?'RED':over===1?'YELLOW':'GREEN';
  return {z:over,cls,why:`RIR overshoot=${over}`};
}
function velocityReadiness(protocolId){
  const base=baselineForProtocol(protocolId,14); const vals=protocolReadinessValues(protocolId);
  const today=vals.at(-1); if(today===undefined) return {z:0,cls:'GREEN',why:'Ei velocity readiness -dataa'};
  const z=(today-base.median)/(base.madSigma||1e-6);
  return {z,cls:zClass(z),why:`Velocity z=${z.toFixed(2)}`};
}

function recommend(sessionId,variantId){
  const trace=[];
  const sets=state.data.sets.filter(s=>s.variantId===variantId&&trainingSetFilter(s)).sort((a,b)=>String(a.setId).localeCompare(String(b.setId))).slice(-8);
  const prev=sets.at(-1); const prevLoad=prev?.externalLoadKg??0;
  const trend=sets.length>=2?(e1RMExternal(sets.at(-1))-e1RMExternal(sets[0]))/Math.max(1,e1RMExternal(sets[0])):0;
  let deltaPctRaw=trend>0.02?0.025:trend<-0.02?-0.025:0;
  trace.push({ruleId:'trend_raw',before:{deltaPctRaw:0},after:{deltaPctRaw},why:`Trend ${trend.toFixed(3)}`});

  let deltaPct=clamp(deltaPctRaw,-state.settings.maxDelta,state.settings.maxDelta);
  trace.push({ruleId:'clamp_max_delta',before:{deltaPctRaw},after:{deltaPct},why:`maxDelta=${state.settings.maxDelta}`});

  const p=state.data.protocols.find(x=>x.variantId===variantId&&x.type==='READINESS_VELOCITY');
  const rzV=velocityReadiness(p?.protocolId); const rzH=hrvReadiness(); const rzR=rirReadiness(variantId);
  const capLevel=Math.max(capLevelFromClass(rzV.cls),capLevelFromClass(rzH.cls),capLevelFromClass(rzR.cls));
  trace.push({ruleId:'cap_level',before:{},after:{capLevel,velocity:rzV,hrv:rzH,rir:rzR},why:'Cap-only integraatio'});

  if(capLevel===2){const before=deltaPct; deltaPct=Math.min(deltaPct,0); trace.push({ruleId:'cap_red_no_increase',before:{deltaPct:before},after:{deltaPct},why:'RED ei nostoja'});}
  if(capLevel===1){const before=deltaPct; deltaPct=deltaPct*0.5; trace.push({ruleId:'cap_yellow_half',before:{deltaPct:before},after:{deltaPct},why:'YELLOW puolittaa'});}

  const sess=sessionById(sessionId); let targetSetRole='top';
  if(sess?.plannedDayType==='heavy' && capLevel===2){
    const before=deltaPct; targetSetRole=state.settings.redFallbackDay==='volume'?'volume':'technique';
    deltaPct=clamp(deltaPct-0.025,-state.settings.maxDelta,state.settings.maxDelta);
    trace.push({ruleId:'heavy_red_fallback',before:{deltaPct:before,targetSetRole:'top'},after:{deltaPct,targetSetRole},why:'RED heavy -> fallback + -2.5%'});
  }

  const targetLoadKg=Math.max(0, +(prevLoad*(1+deltaPct)).toFixed(2));
  const rec={recId:uid(),sessionId,variantId,targetSetRole,targetLoadKg,deltaPct,capLevel,createdAtISO:new Date().toISOString()};
  return {rec,trace};
}

function weeklyStimulus(weekStartISO){
  const start=new Date(weekStartISO+'T00:00:00'); const end=new Date(start.getTime()+7*86400000);
  const sess=state.data.sessions.filter(s=>{const d=new Date(s.dateISO+'T00:00:00'); return d>=start&&d<end;});
  const ids=new Set(sess.map(s=>s.sessionId));
  const sets=state.data.sets.filter(s=>ids.has(s.sessionId));
  const primary=sets.filter(s=>s.variantId===state.settings.pullupVariantId);
  return {
    heavyExposureCount: primary.filter(s=>s.setRole==='top'&&s.reps<=3).length,
    totalPullSets: sets.filter(s=>['top','backoff','volume','speed','technique','accessory'].includes(s.setRole)).length,
    totalTonnageExternal: sum(primary.map(s=>s.externalLoadKg*s.reps)),
    totalTonnageSystem: sum(primary.map(s=>systemLoad(s)*s.reps)),
    accessoryPullVolume: sets.filter(s=>s.setRole==='accessory').length
  };
}

function computeVLForSet(setId){
  const reps=state.data.repMetrics.filter(r=>r.setId===setId).sort((a,b)=>a.repNumber-b.repNumber);
  if(reps.length<2) return null;
  const first=num(reps[0].velocityMean), last=num(reps.at(-1).velocityMean);
  if(!first||!last) return null;
  return ((first-last)/first)*100;
}

// (6) import/export
function backupJSON(){return {appVersion:APP_VERSION,schemaVersion:SCHEMA_VERSION,timezone:TIMEZONE,data:state.data};}
function download(name,content,type='application/json'){const b=new Blob([content],{type}); const a=document.createElement('a'); a.href=URL.createObjectURL(b); a.download=name; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(a.href);}
async function restoreJSON(file){const txt=await file.text(); const parsed=JSON.parse(txt); const migrated=migrateBackupJson(parsed); for(const s of STORE_NAMES) await clearStore(s); state.data=migrated.data; await saveAll(); await loadAll(); render();}
function exportSetsCSV(){
  const head=['setId','sessionId','dateISO','variantId','setRole','externalLoadKg','reps','rir','velocityMean','velocityPeak','systemLoadKg'];
  const rows=[head.join(',')];
  for(const set of state.data.sets){const ses=sessionById(set.sessionId)||{}; rows.push([set.setId,set.sessionId,ses.dateISO||'',set.variantId,set.setRole,set.externalLoadKg,set.reps,set.rir??'',set.velocityMean??'',set.velocityPeak??'',systemLoad(set)].join(','));}
  return rows.join('\n');
}

function parseCSV(text){const lines=text.split(/\r?\n/).filter(Boolean); if(lines.length<2)return {headers:[],rows:[]}; const headers=lines[0].split(',').map(x=>x.trim()); const rows=lines.slice(1).map(l=>{const c=l.split(','); const o={}; headers.forEach((h,i)=>o[h]=c[i]); return o;}); return {headers,rows};}
async function importMappedCSV(mapping, rows){
  const sessionId=uid();
  const dateISO=helsinkiISO();
  state.data.sessions.push({sessionId,dateISO,plannedDayType:'volume',schemaVersion:SCHEMA_VERSION});
  for(const r of rows){
    const variantName=r[mapping.movementVariant]||'Pronated standard';
    let variant=state.data.variants.find(v=>v.name===variantName);
    if(!variant){variant={variantId:uid(),movementId:'m_pullup',name:variantName};state.data.variants.push(variant)}
    state.data.sets.push({setId:uid(),sessionId,variantId:variant.variantId,setRole:'top',externalLoadKg:Math.max(0,num(r[mapping.externalLoadKg])??0),reps:Math.max(1,Math.trunc(num(r[mapping.reps])??1)),velocityMean:num(r[mapping.velocityMean]),velocityPeak:num(r[mapping.velocityPeak]),deviceMeta:{deviceType:'unknown',liftPhase:'concentric_only',velocitySource:'measured'},qualityFlags:[]});
  }
  await saveAll(); render();
}

// (7) UI
function badgeClass(cls){return cls==='GREEN'?'g':cls==='YELLOW'?'y':'r'}
function renderTabs(){const root=document.getElementById('tabs'); root.innerHTML=tabs.map(t=>`<button class="${state.tab===t?'active':''}" data-tab="${t}">${t}</button>`).join(''); root.querySelectorAll('button').forEach(b=>b.onclick=()=>{state.tab=b.dataset.tab; render();});}
function renderHeader(){document.getElementById('versionBanner').textContent=`v${APP_VERSION} / schema ${SCHEMA_VERSION} / ${TIMEZONE}`}

function viewDashboard(){
  const today=state.data.sessions.find(s=>s.dateISO===helsinkiISO())||{sessionId:null,dateISO:helsinkiISO(),plannedDayType:'heavy'};
  const p=state.data.protocols.find(x=>x.variantId===state.settings.pullupVariantId&&x.type==='READINESS_VELOCITY');
  const v=velocityReadiness(p?.protocolId), h=hrvReadiness(), r=rirReadiness(state.settings.pullupVariantId);
  const cap=Math.max(capLevelFromClass(v.cls),capLevelFromClass(h.cls),capLevelFromClass(r.cls));
  const rec=today.sessionId?recommend(today.sessionId,state.settings.pullupVariantId):null;
  const weekStart=helsinkiISO(new Date(Date.now()-((new Date().getDay()+6)%7)*86400000));
  const ws=weeklyStimulus(weekStart);
  const recent=state.data.sessions.slice().sort((a,b)=>b.dateISO.localeCompare(a.dateISO)).slice(0,8);
  return `<div class="grid">
    <div class="card"><h2>Readiness</h2>
      <p>Velocity <span class="pill ${badgeClass(v.cls)}">${v.cls}</span> ${v.why}</p>
      <p>HRV <span class="pill ${badgeClass(h.cls)}">${h.cls}</span> ${h.why}</p>
      <p>RIR <span class="pill ${badgeClass(r.cls)}">${r.cls}</span> ${r.why}</p>
      <p class="big">CapLevel: ${cap}</p>
    </div>
    <div class="card"><h2>Suositus</h2>
      ${rec?`<p>Edellinen kuorma: ${(state.data.sets.filter(s=>s.variantId===state.settings.pullupVariantId).at(-1)?.externalLoadKg??0)} kg</p>
      <p>Ehdotus: <b>${rec.rec.targetLoadKg} kg</b> (${(rec.rec.deltaPct*100).toFixed(1)}%) role=${rec.rec.targetSetRole}</p>
      <details><summary>decisionTrace</summary><pre>${esc(JSON.stringify(rec.trace,null,2))}</pre></details>`:'<p class="muted">Luo tÃ¤nÃ¤Ã¤n sessio Session-vÃ¤lilehdellÃ¤.</p>'}
    </div>
    <div class="card"><h2>Weekly stimulus</h2>
      <p>heavyExposureCount: ${ws.heavyExposureCount}</p><p>totalPullSets: ${ws.totalPullSets}</p><p>External tonnage: ${ws.totalTonnageExternal.toFixed(1)}</p><p>System tonnage: ${ws.totalTonnageSystem.toFixed(1)}</p>
    </div>
    <div class="card"><h2>Recent sessions</h2>
      <table><tr><th>PVM</th><th>DayType</th><th>Setit</th></tr>${recent.map(s=>`<tr><td>${s.dateISO}</td><td>${s.plannedDayType}</td><td>${state.data.sets.filter(x=>x.sessionId===s.sessionId).length}</td></tr>`).join('')}</table>
    </div>
  </div>`;
}

function viewSession(){
  return `<div class="grid"><div class="card"><h2>Nopea session kirjaus</h2>
    <div class="row3"><label>PÃ¤ivÃ¤<input id="s_date" type="date" value="${helsinkiISO()}"/></label>
    <label>DayType<select id="s_day">${DAY_TYPES.map(d=>`<option>${d}</option>`).join('')}</select></label>
    <label>Bodyweight kg<input id="s_bw" placeholder="82,5"/></label></div>
    <label>Muistiinpano<textarea id="s_notes"></textarea></label>
    <button class="primary" id="s_create">1) Luo sessio</button>
    <hr><h3>Readiness test</h3>
    <div class="row3"><label>Protocol<select id="s_protocol">${state.data.protocols.filter(p=>p.type==='READINESS_VELOCITY').map(p=>`<option value="${p.protocolId}">${p.protocolId}</option>`).join('')}</select></label>
    <label>Velocity mean<input id="s_vmean" placeholder="0.35"/></label><label>Velocity peak<input id="s_vpeak" placeholder=""/></label></div>
    <button id="s_addReadiness">2) LisÃ¤Ã¤ readiness_test</button>
    <hr><h3>Top/Backoff setit</h3>
    <label>Bulk (esim: leuat +60x3 @RIR2 v0.32)</label><textarea id="s_bulk"></textarea>
    <button id="s_addBulk">3) Tallenna bulk-setit</button>
    <p class="muted">Manual override kirjataan automaattisesti editorimuutoksissa (perusversio).</p>
  </div>
  <div class="card"><h2>Laatuvahdit</h2>
    <p>velocity range: (0,3.0], reps 1..30, load >=0, HRV rajat asetuksissa.</p>
    <p>Poikkeama >40% baseline medianista -> vahvistuskysely.</p>
    <p>VL% lasketaan jos repMetrics saatavilla.</p>
  </div></div>`;
}

function viewPlanner(){
  const week=['Ma','Ti','Ke','To','Pe','La','Su'];
  const plan=state.data.planner.slice(-7);
  return `<div class="grid"><div class="card"><h2>Microcycle planner</h2>
    <table><tr><th>PÃ¤ivÃ¤</th><th>dayType</th></tr>${week.map((d,i)=>`<tr><td>${d}</td><td><select data-plan="${i}">${DAY_TYPES.map(t=>`<option ${plan[i]?.dayType===t?'selected':''}>${t}</option>`).join('')}</select></td></tr>`).join('')}</table>
    <button id="savePlan">Tallenna viikkosuunnitelma</button>
    <button id="applyToday">Apply plan to today</button>
  </div><div class="card"><h2>Plan vs performed</h2><pre>${esc(JSON.stringify(weeklyStimulus(helsinkiISO(new Date(Date.now()-((new Date().getDay()+6)%7)*86400000))),null,2))}</pre></div></div>`;
}

function viewImportExport(){
  return `<div class="grid"><div class="card"><h2>Backup/Restore</h2>
    <button id="expBackup">Backup JSON</button>
    <label>Restore JSON<input id="impBackup" type="file" accept="application/json"/></label>
    <button id="expCsv">Export CSV</button>
  </div>
  <div class="card"><h2>Vendor CSV mapping (P1)</h2>
    <label>CSV<input id="impCsv" type="file" accept=".csv,text/csv"/></label>
    <div id="mapUi" class="muted">Lataa CSV nÃ¤hdÃ¤ksesi header-mÃ¤ppÃ¤yksen.</div>
  </div>
  <div class="card"><h2>API integration (P2)</h2><p class="warn">Experimental: GymAware Cloud stub (ei endpointteja tÃ¤ssÃ¤ versiossa).</p></div></div>`;
}

function viewCalibration(){
  const p=state.data.protocols.find(x=>x.type==='READINESS_VELOCITY'&&x.variantId===state.settings.pullupVariantId);
  const b=baselineForProtocol(p?.protocolId,14); const vals=protocolReadinessValues(p?.protocolId);
  return `<div class="grid"><div class="card"><h2>Calibration</h2>
    <p>protocol: ${p?.protocolId||'-'}</p><p>median: ${b.median?.toFixed?.(3)??'-'} / madSigma: ${b.madSigma?.toFixed?.(3)??'-'} / N=${b.n}</p>
    <p>flags: ${(b.flags||[]).join(', ')||'none'}</p>
    <button id="resetBase">Reset baseline (vahvista)</button>
    <pre>${esc(JSON.stringify(vals.slice(-30),null,2))}</pre>
  </div></div>`;
}

function viewDiagnostics(){
  return `<div class="grid"><div class="card"><h2>Diagnostics + tests</h2>
    <button id="runTests">Run tests (P0)</button>
    <div id="testOut" class="muted"></div>
    <p>Store counts:</p><pre>${esc(JSON.stringify(Object.fromEntries(STORE_NAMES.map(s=>[s,state.data[s].length])),null,2))}</pre>
  </div></div>`;
}

function viewSettings(){
  return `<div class="grid"><div class="card"><h2>Asetukset</h2>
    <label>HRV mode<select id="cfg_hrv"><option>lnRMSSD</option><option>RMSSD_ms</option><option>score_0_100</option></select></label>
    <label>HRV window N<input id="cfg_n" value="${state.settings.hrvWindow}"/></label>
    <label>maxDelta (0.05=5%)<input id="cfg_max" value="${state.settings.maxDelta}"/></label>
    <label>RED heavy fallback<select id="cfg_red"><option value="technique">technique</option><option value="volume">volume</option></select></label>
    <button id="saveCfg">Tallenna</button>
    <p class="muted">v${APP_VERSION} / schema ${SCHEMA_VERSION}</p>
  </div></div>`;
}

function render(){
  renderHeader(); renderTabs();
  const root=document.getElementById('view');
  root.innerHTML=state.tab==='Dashboard'?viewDashboard():state.tab==='Session'?viewSession():state.tab==='Planner'?viewPlanner():state.tab==='Tuonti/Vienti'?viewImportExport():state.tab==='Calibration'?viewCalibration():state.tab==='Diagnostics'?viewDiagnostics():viewSettings();
  bindEvents();
  localStorage.setItem(LS_BOOT, JSON.stringify({lastOpenedISO:new Date().toISOString(),appVersion:APP_VERSION}));
}

function bindEvents(){
  const g=id=>document.getElementById(id);
  g('s_create') && (g('s_create').onclick=async()=>{const s={sessionId:uid(),schemaVersion:SCHEMA_VERSION,dateISO:g('s_date').value||helsinkiISO(),plannedDayType:g('s_day').value,notes:g('s_notes').value,bodyweightKg:num(g('s_bw').value)}; state.data.sessions.push(s); await put('sessions',s); alert('Sessio luotu'); render();});
  g('s_addReadiness') && (g('s_addReadiness').onclick=async()=>{const sess=state.data.sessions.find(s=>s.dateISO===(g('s_date').value||helsinkiISO())); if(!sess) return alert('Luo sessio ensin'); const protocolId=g('s_protocol').value; const p=state.data.protocols.find(x=>x.protocolId===protocolId); const v=num(g('s_vmean').value), pk=num(g('s_vpeak').value); if(v!==null && (v<=0 || v>3)) return alert('Velocity out of range'); const base=baselineForProtocol(protocolId,14); if(v!==null && base.median && Math.abs(v-base.median)/Math.max(base.median,1e-6)>0.4 && !confirm('Velocity poikkeaa >40% baseline: tallenna silti?')) return; const set={setId:uid(),sessionId:sess.sessionId,variantId:p.variantId,setRole:'readiness_test',externalLoadKg:0,reps:1,velocityMean:v,velocityPeak:pk,testProtocolId:protocolId,deviceMeta:{deviceType:'manual',liftPhase:'concentric_only',velocitySource:'measured'},qualityFlags:[]}; state.data.sets.push(set); await put('sets',set); alert('Readiness tallennettu'); render();});
  g('s_addBulk') && (g('s_addBulk').onclick=async()=>{const sess=state.data.sessions.find(s=>s.dateISO===(g('s_date').value||helsinkiISO())); if(!sess) return alert('Luo sessio ensin'); const text=g('s_bulk').value||''; const m=text.match(/([+\-]?\d+[\.,]?\d*)x(\d+).*?(?:@RIR\s*([0-9\.,]+))?.*?(?:v([0-9\.,]+))?/i); if(!m) return alert('Parseri ei tunnistanut riviÃ¤'); const set={setId:uid(),sessionId:sess.sessionId,variantId:state.settings.pullupVariantId,setRole:'top',externalLoadKg:Math.max(0,num(m[1])??0),reps:Math.max(1,Math.min(30,Math.trunc(num(m[2])??1))),rir:num(m[3]),velocityMean:num(m[4]),deviceMeta:{deviceType:'manual',liftPhase:'concentric_only',velocitySource:'measured'},qualityFlags:[]}; state.data.sets.push(set); await put('sets',set); alert('Setti tallennettu'); render();});

  g('savePlan') && (g('savePlan').onclick=async()=>{state.data.planner=[]; document.querySelectorAll('[data-plan]').forEach((el,i)=>state.data.planner.push({planId:`plan-${i}`,weekday:i,dayType:el.value})); await clearStore('planner'); for(const p of state.data.planner) await put('planner',p); alert('Suunnitelma tallennettu');});
  g('applyToday') && (g('applyToday').onclick=async()=>{const wd=(new Date().getDay()+6)%7; const d=state.data.planner.find(p=>p.weekday===wd)?.dayType||'volume'; const s={sessionId:uid(),schemaVersion:SCHEMA_VERSION,dateISO:helsinkiISO(),plannedDayType:d,notes:'Auto from planner'}; state.data.sessions.push(s); await put('sessions',s); alert('Plan applied'); render();});

  g('expBackup') && (g('expBackup').onclick=()=>download(`backup-${helsinkiISO()}.json`,JSON.stringify(backupJSON(),null,2)));
  g('impBackup') && (g('impBackup').onchange=async e=>{if(!e.target.files[0])return; await restoreJSON(e.target.files[0]); alert('Restore valmis');});
  g('expCsv') && (g('expCsv').onclick=()=>download(`sets-${helsinkiISO()}.csv`,exportSetsCSV(),'text/csv'));
  g('impCsv') && (g('impCsv').onchange=async e=>{if(!e.target.files[0])return; const txt=await e.target.files[0].text(); const parsed=parseCSV(txt); state.mappingDraft=parsed; const h=parsed.headers; const opts=x=>`<select id="map_${x}">${h.map(k=>`<option>${k}</option>`).join('')}</select>`; document.getElementById('mapUi').innerHTML=`<p>Map columns</p><div class='row3'><label>movementVariant${opts('movementVariant')}</label><label>externalLoadKg${opts('externalLoadKg')}</label><label>reps${opts('reps')}</label></div><div class='row'><label>velocityMean${opts('velocityMean')}</label><label>velocityPeak${opts('velocityPeak')}</label></div><button id='mapCommit'>Import preview+commit</button>`; document.getElementById('mapCommit').onclick=async()=>{const mapping={movementVariant:map_movementVariant.value,externalLoadKg:map_externalLoadKg.value,reps:map_reps.value,velocityMean:map_velocityMean.value,velocityPeak:map_velocityPeak.value}; await importMappedCSV(mapping,parsed.rows); alert('CSV import valmis');};});

  g('resetBase') && (g('resetBase').onclick=async()=>{if(!confirm('Nollataanko baselinet?'))return; state.data.baselines=[]; await clearStore('baselines'); alert('Nollattu'); render();});

  g('runTests') && (g('runTests').onclick=()=>{const r=runTests(); document.getElementById('testOut').innerHTML=`<pre>${esc(JSON.stringify(r,null,2))}</pre>`;});

  g('saveCfg') && (g('saveCfg').onclick=()=>{state.settings.hrvMode=g('cfg_hrv').value; state.settings.hrvWindow=Math.max(3,Math.trunc(num(g('cfg_n').value)||14)); state.settings.maxDelta=clamp(num(g('cfg_max').value)||0.05,0,0.2); state.settings.redFallbackDay=g('cfg_red').value; alert('Tallennettu muistiin'); render();});
  g('cfg_hrv') && (g('cfg_hrv').value=state.settings.hrvMode);
  g('cfg_red') && (g('cfg_red').value=state.settings.redFallbackDay);
}

// (8) pwa hooks
function registerSW(){if('serviceWorker' in navigator){navigator.serviceWorker.register('./sw.js').catch(()=>{});}}

// (9) tests
function test(name,fn){try{return {name,ok:!!fn()}}catch(e){return {name,ok:false,error:String(e)}}}
function runTests(){
  const fixtureOld={schemaVersion:2,data:{sessions:[{id:'a',date:'2026-01-01',sets:'3',weight:'50',reps:'3'}]}};
  const migrated=migrateBackupJson(fixtureOld);
  const t=[
    test('median/MAD',()=>median([1,2,3,4])===2.5 && Math.abs(madSigma([1,1,1])-1e-6)<1e-10),
    test('z-thresholds',()=>zClass(-0.4)==='GREEN'&&zClass(-0.7)==='YELLOW'&&zClass(-1.2)==='RED'),
    test('migration fixtures',()=>migrated.schemaVersion===3 && migrated.data.sessions.length===1),
    test('cap-only red never increase',()=>{const s={sessionId:'s1',dateISO:helsinkiISO(),plannedDayType:'heavy'}; state.data.sessions=[s]; state.data.sets=[{setId:'x',sessionId:'s1',variantId:'v_pullup_weighted',setRole:'top',externalLoadKg:50,reps:3,rir:0,targetRIR:2}]; state.data.protocols=[{protocolId:'p',variantId:'v_pullup_weighted',type:'READINESS_VELOCITY',metric:'velocityMean',loadDef:{mode:'ABS_KG',value:0},reps:1,useInRecommendations:true}]; const r=recommend('s1','v_pullup_weighted'); return r.rec.deltaPct<=0;})
  ];
  const passed=t.filter(x=>x.ok).length;
  return {summary:`${passed}/${t.length} passed`,details:t};
}

async function bootstrap(){
  state.db=await openDB();
  await loadAll();
  if(!state.data.movements.length){state.data=defaultData(); await saveAll(); await loadAll();}
  const q=new URLSearchParams(location.search); if(q.get('test')==='1') state.tab='Diagnostics';
  registerSW(); render();
}
bootstrap();
})();
</script>
</body>
</html>

